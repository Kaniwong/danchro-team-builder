<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è§’è‰²ç¼–é˜Ÿå·¥å…·</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #f7f7f7;
    }

    h1 {
      font-size: 24px;
    }

    h2 {
      margin-top: 30px;
      font-size: 20px;
    }

    .pool-group {
      margin-bottom: 20px;
    }

    .character-pool,
    .team-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 15px 0;
      justify-content: center;
    }

    .character,
    .slot {
      width: 70px;
      height: 70px;
      border: 2px dashed #ccc;
      border-radius: 10px;
      background-color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      box-sizing: border-box;
    }

    .character img,
    .slot img {
      max-width: 100%;
      max-height: 100%;
    }

    .character.dragging {
      opacity: 0.5;
    }

    .used {
      opacity: 0.3;
      pointer-events: none;
    }

    .team-container {
      margin-bottom: 20px;
      padding: 10px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    .team-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .team-label {
      font-weight: bold;
      outline: none;
    }

    button {
      margin-left: 6px;
      cursor: pointer;
    }

    #filters button {
      margin-right: 4px;
    }

    .character-pool {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 5px;
      background: #fff;
    }

    .team-container.dragging {
      opacity: 0.5;
      border: 2px dashed #888;
    }

    #overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      display: none;
      z-index: 998;
    }

    #eligibleSelector {
      z-index: 999;
      width: 80%;
    }

    #eligibleList {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 10px;
    }

    #filters button.active {
      background: #007bff;
      color: white;
      border: 2px solid #0056b3;
    }

    .drag-handle {
      width: 28px;
      height: 100%;
      min-width: 18px;
      min-height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: grab;
      background: none;
      border: none;
      padding: 0 2px;
      margin-right: 10px;
      opacity: 0.65;
      transition: background 0.2s, box-shadow 0.2s, opacity 0.2s;
      user-select: none;
      z-index: 2;
    }

    .drag-handle:hover,
    .drag-handle:active,
    .drag-handle:focus {
      background: #eaf4ff;
      box-shadow: 0 2px 8px #007bff22;
      opacity: 1;
    }

    .drag-handle svg {
      display: block;
      width: 18px;
      height: 18px;
    }

    .dragging {
      opacity: 0.7;
      box-shadow: 0 4px 16px #007bff33;
    }

    .chosen {
      border: 2px solid #007bff;
    }

    /* ä¸»åŒºåŸŸå¸ƒå±€ */
    #main-layout {
      display: flex;
      gap: 20px;
      align-items: flex-start;
      flex-wrap: wrap;
    }

    /* âœ… ç§»åŠ¨ç«¯ä¼˜åŒ– */
    @media (max-width: 768px) {
      body {
        padding: 0;
      }

      h1 {
        font-size: 20px;
      }

      h2 {
        font-size: 16px;
        margin-top: 16px;
      }

      #main-layout {
        flex-direction: column;
        gap: 12px;
      }

      #main-layout>div {
        width: 100% !important;
        flex: none !important;
      }

      /* å›¾æ ‡ç¼©å° */
      .character,
      .slot {
        width: 45px;
        height: 45px;
      }

      .character-pool,
      .team-row {
        gap: 6px;
        justify-content: center;
      }

      /* æ ‡é¢˜å­—ä½“ */
      .team-label {
        font-size: 14px;
        max-width: 60%;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
      }

      /* æŒ‰é’®ç´§å‡‘ */
      .team-header button {
        font-size: 12px;
        padding: 1px 5px;
        margin-left: 4px;
      }

      /* ç­›é€‰æ¡æ»šåŠ¨ */
      #filters {
        overflow-x: auto;
        white-space: nowrap;
        padding-bottom: 8px;
        font-size: 16px;
        margin-bottom: 0;
      }

      #filters button {
        display: inline-block;
        font-size: 13px;
        padding: 4px 8px;
      }

      #eligibleSelector {
        width: 95% !important;
        max-height: 85vh;
        top: 5%;
        left: 50%;
        transform: translateX(-50%);
        padding: 10px;
        font-size: 14px;
      }

      #eligibleList img {
        width: 50px !important;
        height: 50px !important;
      }

      #eligibleList {
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 6px;
        justify-content: center;
      }

      #eligibleList img {
        width: 48px;
        height: 48px;
      }

      #eligibleList label {
        /* flex-direction: column; */
        align-items: center;
        font-size: 12px;
      }

      #eligibleList input[type="checkbox"] {
        margin-bottom: 4px;
      }

      .character-pool {
        max-height: 240px;
        padding: 4px;
      }

      .team-container {
        padding: 6px;
        padding-bottom: 0;
        margin-bottom: 5px;
      }

      .drag-handle {
        justify-content: flex-start;
      }
    }

    .team-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
      align-items: center;
    }

    /* âœ… ç§»åŠ¨ç«¯æ ·å¼ä¼˜åŒ– */
    @media (max-width: 768px) {
      .team-controls {
        flex-direction: column;
        align-items: stretch;
      }

      .team-controls button,
      .team-controls input[type="file"] {
        font-size: 15px;
        padding: 0;
        width: 100%;
        margin: 0;
      }
    }

    .filters {
      margin-bottom: 12px;
    }

    .filters-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .toggle-filters {
      font-size: 14px;
      padding: 4px 10px;
    }

    .filters-body {
      display: none;
      flex-direction: column;
      gap: 8px;
    }

    .filters.show .filters-body {
      display: flex;
    }

    .filter-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-label {
      flex: 0 0 70px;
      font-weight: bold;
      margin-bottom: 4px;
    }

    .filter-buttons {
      flex: 1;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .filter-buttons.full-width {
      width: 100%;
      justify-content: center;
      gap: 12px;
      margin-left: 0;
      /* å»é™¤ä¹‹å‰çš„ left margin */
    }


    /* âœ… ç§»åŠ¨ç«¯ä¼˜åŒ– */
    @media (max-width: 768px) {
      .filter-label {
        flex: 0 0 64px;
        font-size: 14px;
      }

      .filter-buttons.full-width {
        margin-top: 10px;
      }

      .filter-buttons button {
        font-size: 13px;
        padding: 4px 8px;
      }

      .toggle-filters {
        font-size: 13px;
      }

      /* .filters-body {
    display: none;
  } */


    }

    /* é¡¶éƒ¨å¸ƒå±€ï¼šæ ‡é¢˜å·¦ã€è¯­è¨€ä¸‹æ‹‰å³ */
    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      /* å’Œä¸‹é¢å†…å®¹ä¿æŒè·ç¦» */
    }

    /* ï¼ˆå¯é€‰ï¼‰è®©ä¸‹æ‹‰æ¡†å’ŒæŒ‰é’®å°ºå¯¸æ›´åˆé€‚ */
    .app-header select {
      padding: 4px 8px;
      font-size: 14px;
    }

    :root {
      --primary: #007bff;
      --primary-hover: #0056b3;
      --border-light: #ccc;
      --bg-card: #fff;
      --shadow: rgba(0, 0, 0, 0.1);
    }

    /* å…¨å±€æŒ‰é’®é£æ ¼ */
    button,
    .toggle-filters {
      padding: 6px 12px;
      border: 1px solid var(--border-light);
      background: var(--bg-card);
      border-radius: 4px;
      font-size: 14px;
      transition: background 0.2s, color 0.2s, border-color 0.2s;
    }

    button:hover,
    .toggle-filters:hover {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary-hover);
    }

    button:active {
      background: var(--primary-hover);
    }

    .team-container {
      background: var(--bg-card);
      border: 1px solid var(--border-light);
      border-radius: 8px;
      box-shadow: 0 2px 6px var(--shadow);
      transition: box-shadow 0.2s;
    }

    .team-container:hover {
      box-shadow: 0 4px 12px var(--shadow);
    }

    .slot,
    .character {
      border: 1px solid var(--border-light);
      border-radius: 8px;
      transition: transform 0.15s;
    }

    .slot:hover,
    .character:hover {
      transform: scale(1.05);
    }

    .filters-header {
      padding: 8px;
      background: var(--bg-card);
      border: 1px solid var(--border-light);
      border-radius: 4px 4px 0 0;
    }

    .filters-body {
      padding: 10px;
      background: var(--bg-card);
      border: 1px solid var(--border-light);
      border-top: none;
      border-radius: 0 0 4px 4px;
    }

    .filter-row {
      margin-bottom: 8px;
    }

    .filter-label {
      width: 80px;
    }

    .filter-buttons button {
      margin: 0 4px 4px 0;
    }

    body {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f3f4f6;
    }

    .app-header {
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border-light);
      margin-bottom: 20px;
    }

    #main-layout {
      gap: 30px;
    }

    .pool-group h2 {
      margin-bottom: 10px;
      font-size: 18px;
    }

    .team-controls {
      gap: 12px;
    }

    body {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f3f4f6;
    }

    .app-header {
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border-light);
      margin-bottom: 20px;
    }

    #main-layout {
      gap: 30px;
    }

    .pool-group h2 {
      margin-bottom: 10px;
      font-size: 18px;
    }

    .team-controls {
      gap: 12px;
    }

    .team-container {
      flex: 1;
    }

    @media (max-width: 768px) {

      /* éšè—å·¦ä¾§çš„å†’é™©è€…ï¼æ”¯æ´è€…æ±  */
      .pool-group {
        display: none;
      }

      #main-layout {
        gap: 0;
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      border-bottom: 1px solid #ccc;
    }

    .modal-close {
      border: none;
      background: transparent;
      font-size: 18px;
      line-height: 1;
      cursor: pointer;
    }

    /* åªåœ¨æ‰‹æœºç«¯ï¼ˆâ‰¤768pxï¼‰ç”Ÿæ•ˆ */
    @media (max-width: 768px) {

      /* ç¡®ä¿ slot é‡Œæ²¡æœ‰ img çš„æ‰æ˜¾ç¤ºåŠ å· */
      .slot:empty::after {
        content: "+";
        /* åŠ å·æç¤º */
        font-size: 1.5rem;
        /* å¤§å°å¯è°ƒ */
        color: #ccc;
        /* é¢œè‰²å¯è°ƒ */
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none;
        /* ä¸å½±å“ç‚¹å‡»äº‹ä»¶ */
      }
    }

/* âœ… è®©å¼¹çª—é‡Œçš„ç­›é€‰åŒºå§‹ç»ˆå¯è§ */
#eligibleFiltersContainer{
  display:flex!important;
  flex-direction:column;
  gap:8px;
  border: none;
}


    /* å¼¹çª—ç­›é€‰è¡Œçš„æŒ‰é’®é«˜äº®è‰² */
#eligibleFiltersContainer button.active {
  background: var(--primary);
  color:#fff;
}

/* è®©è¿‡æ»¤è¡Œä¹‹é—´æœ‰ç‚¹é—´è·ï¼Œçœ‹ç€ä¸å † */
#eligibleFiltersContainer .filter-row:not(:last-child) {
  margin-bottom: 8px;
}

/* è®©æŒ‰é’®åˆ«å¤ªçª„ */
#eligibleFiltersContainer .filter-buttons button {
  min-width: 48px;
}


  </style>
  <script>
    const i18n = {
      zh: {
        title: "è§’è‰²ç¼–é˜Ÿå·¥å…·",
        filterLabel: "ç­›é€‰ï¼š",
        rarity: "ç¨€æœ‰åº¦ï¼š",
        attribute: "å±æ€§ï¼š",
        roleType: "å®šä½ï¼š",
        reset: "é‡ç½®",
        eligible: "ğŸ® è®¾ç½®å¯ä¸Šåœºè§’è‰²",
        addTeam: "æ·»åŠ æ–°é˜Ÿä¼",
        export: "ğŸ“¤ å¯¼å‡º",
        deleteTeam: "åˆ é™¤é˜Ÿä¼",
        clear: "æ¸…ç©º",
        import: "å¯¼å…¥é…ç½®",
        save: "âœ… ä¿å­˜",
        close: "âŒ å…³é—­",
        expandFilter: "å±•å¼€ç­›é€‰",
        collapseFilter: "æ”¶èµ·ç­›é€‰",
        team: name => `é˜Ÿä¼ ${name}`,
        conflictAlert: name => `è¯¥å°ç»„ä¸­ä¸èƒ½å‡ºç°é‡å¤è§’è‰²ï¼š${name}`,
        dropConflict: "æ‹–æ‹½åä¼šå¯¼è‡´åŒç»„å‡ºç°é‡å¤è§’è‰²ï¼Œæ“ä½œè¢«å–æ¶ˆï¼",
        clearConfirm: name => `ç¡®å®šæ¸…ç©º ${name}?`,
        deleteConfirm: name => `ç¡®å®šåˆ é™¤ ${name}?`,
        adventurerLabel: "å†’é™©è€…",
        supporterLabel: "æ”¯æ´è€…",
        teamBuilderLabel: "é˜Ÿä¼ç¼–é˜Ÿ",
        setupYourPool: "è®¾ç½®ä½ çš„è§’è‰²æ± ",
        eligibleListMissing: "æ‰¾ä¸åˆ°å¯é€‰åˆ—è¡¨å…ƒç´ ï¼Œè¯·æ£€æŸ¥ HTML æ˜¯å¦æ­£ç¡®æ’å…¥ï¼",
        import: "å¯¼å…¥é…ç½®",
        attribute_FIRE: "ç«",
        attribute_WIND: "é£",
        attribute_EARTH: "åœŸ",
        attribute_ELECTRIC: "é›·",
        attribute_WATER: "æ°´",
        roleType_ATTACK: "æ”»å‡»",
        roleType_DEFENSE: "é˜²å¾¡",
        roleType_SPEED: "é€Ÿåº¦",
        roleType_SUPPORT: "è¾…åŠ©",
        allLabel: "å…¨éƒ¨",
      },
      en: {
        title: "Team Builder",
        filterLabel: "Filters:",
        rarity: "Rarity:",
        attribute: "Attribute:",
        roleType: "Role:",
        reset: "Reset",
        eligible: "ğŸ® Select Eligible Characters",
        addTeam: "Add Team",
        export: "ğŸ“¤ Export",
        deleteTeam: "Delete Team",
        clear: "Clear",
        import: "Import Config",
        save: "âœ… Save",
        close: "âŒ Close",
        expandFilter: "Expand Filters",
        collapseFilter: "Collapse Filters",
        team: name => `Team ${name}`,
        conflictAlert: name => `Duplicate character in group: ${name}`,
        dropConflict: "This move would create a duplicate character. Action cancelled.",
        clearConfirm: name => `Clear ${name}?`,
        deleteConfirm: name => `Delete ${name}?`,
        adventurerLabel: "Adventurers",
        supporterLabel: "Supporters",
        teamBuilderLabel: "Team Formation",
        setupYourPool: "Setup Your Character Pool",
        eligibleListMissing: "Cannot find eligibleList containerâ€”please check your HTML.",
        import: "Import Config",
        attribute_FIRE: "Fire",
        attribute_WIND: "Wind",
        attribute_EARTH: "Earth",
        attribute_ELECTRIC: "Electric",
        attribute_WATER: "Water",
        roleType_ATTACK: "Attack",
        roleType_DEFENSE: "Defense",
        roleType_SPEED: "Speed",
        roleType_SUPPORT: "Support",
        allLabel: "All", 
      },
      ja: {
        title: "ç·¨æˆãƒ„ãƒ¼ãƒ«",
        filterLabel: "ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼š",
        rarity: "ãƒ¬ã‚¢ãƒªãƒ†ã‚£ï¼š",
        attribute: "å±æ€§ï¼š",
        roleType: "å½¹å‰²ï¼š",
        reset: "ãƒªã‚»ãƒƒãƒˆ",
        eligible: "ğŸ® ä½¿ç”¨å¯èƒ½ã‚­ãƒ£ãƒ©è¨­å®š",
        addTeam: "ãƒãƒ¼ãƒ è¿½åŠ ",
        export: "ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ",
        deleteTeam: "ãƒãƒ¼ãƒ å‰Šé™¤",
        clear: "ã‚¯ãƒªã‚¢",
        import: "ã‚¤ãƒ³ãƒãƒ¼ãƒˆ",
        save: "âœ… ä¿å­˜",
        close: "âŒ é–‰ã˜ã‚‹",
        expandFilter: "ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’å±•é–‹",
        collapseFilter: "ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’æŠ˜ã‚ŠãŸãŸã‚€",
        team: name => `ãƒãƒ¼ãƒ  ${name}`,
        conflictAlert: name => `åŒã˜ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼š${name}`,
        dropConflict: "åŒã˜ã‚­ãƒ£ãƒ©ãŒã„ã‚‹ãŸã‚ã€ã“ã®æ“ä½œã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚",
        adventurerLabel: "å†’é™ºè€…",
        supporterLabel: "ã‚µãƒãƒ¼ã‚¿ãƒ¼",
        teamBuilderLabel: "ãƒãƒ¼ãƒ ç·¨æˆ",
        setupYourPool: "ä½¿ç”¨ã‚­ãƒ£ãƒ©ã®è¨­å®š",
        eligibleListMissing: "eligibleList è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚HTML æŒ¿å…¥ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚",
        import: "ã‚¤ãƒ³ãƒãƒ¼ãƒˆ",
        attribute_FIRE: "ç«",
        attribute_WIND: "é¢¨",
        attribute_EARTH: "åœŸ",
        attribute_ELECTRIC: "é›·",
        attribute_WATER: "æ°´",
        roleType_ATTACK: "æ”»æ’ƒ",
        roleType_DEFENSE: "é˜²å¾¡",
        roleType_SPEED: "ã‚¹ãƒ”ãƒ¼ãƒ‰",
        roleType_SUPPORT: "ã‚µãƒãƒ¼ãƒˆ",
        clearConfirm: name => `${name} ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ`,
        deleteConfirm: name => `${name} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`,
        allLabel: "ã™ã¹ã¦",
      }
    };

  </script>
</head>

<body>
  <header class="app-header">
    <h1 data-t-key="title"></h1>
    <select id="languageSelector" onchange="changeLanguage(this.value)">
      <option value="zh">ä¸­æ–‡</option>
      <option value="en">English</option>
      <option value="ja">æ—¥æœ¬èª</option>
    </select>
  </header>
  <!-- <select id="languageSelector" onchange="changeLanguage(this.value)">
    <option value="zh">ä¸­æ–‡</option>
    <option value="en">English</option>
    <option value="ja">æ—¥æœ¬èª</option>
  </select>
  <h1>è§’è‰²ç¼–é˜Ÿå·¥å…·</h1> -->

<!-- â–¶ï¸ ä¸»ç­›é€‰ + æŠ˜å å¤–å£³ -->
<div id="filters" class="filters">
  <div class="filters-header">
    <strong data-t-key="filterLabel"></strong>
    <button class="toggle-filters"
            data-t-key="expandFilter"
            onclick="toggleFilterPanel()"></button>
  </div>
  <!-- çœŸæ­£æ¸²æŸ“æŒ‰é’®çš„å®¹å™¨ -->
  <div id="mainFilters" class="filters-body"></div>
</div>


  <div id="overlay" onclick="closeEligibleSelector()"></div>
<div id="eligibleSelector"
     style="display:none; background:#fff; border:1px solid #ccc;
            padding:10px; position:fixed; top:10%; left:50%;
            transform:translateX(-50%); max-height:80vh; overflow:auto; z-index:999;">

  <h3 data-t-key="setupYourPool">è®¾ç½®ä½ çš„è§’è‰²æ± </h3>


<div id="eligibleFiltersContainer" class="filters-body"></div>

  <!-- è§’è‰²ç½‘æ ¼ -->
  <div id="eligibleList"></div>
</div>




  <div id="main-layout">
    <div style="flex: 1;">
      <div class="pool-group">
        <h2 data-t-key="adventurerLabel">å†’é™©è€…</h2>
        <div class="character-pool" id="adventurers"></div>
      </div>
      <div class="pool-group">
        <h2 data-t-key="supporterLabel">æ”¯æ´è€…</h2>
        <div class="character-pool" id="supporters"></div>
      </div>
    </div>

    <div style="flex: 1;">
      <h2 data-t-key="teamBuilderLabel">é˜Ÿä¼ç¼–é˜Ÿ</h2>
      <div id="teams"></div>
      <div class="team-controls" style="margin-top: 10px;">
        <button onclick="addTeam()" data-t-key="addTeam">æ·»åŠ æ–°é˜Ÿä¼</button>
        <button onclick="exportConfig()" data-t-key="export">ğŸ“¤ å¯¼å‡º</button>
        <!-- <input type="file" accept="application/json" onchange="importConfig(event)" /> -->
        <button onclick="fileInput.click()" data-t-key="import">ğŸ“‚ å¯¼å…¥</button>
        <input id="fileInput" type="file" accept="application/json" style="display:none"
          onchange="importConfig(event)" />
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/drag-drop-touch/DragDropTouch.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <script>
    new Sortable(document.getElementById('teams'), {
      animation: 180,
      handle: '.drag-handle',
      ghostClass: 'dragging',
      chosenClass: 'chosen',
      onEnd: function (evt) {
        // evt.oldIndex, evt.newIndexï¼Œé˜Ÿä¼é¡ºåºå·²è‡ªåŠ¨è°ƒæ•´
        saveToLocal(); // è‡ªå·±çš„å­˜å‚¨é€»è¾‘
      }
    });
  </script>
  <script src="character-pool.js"></script>
  <script>
    let teamCounter = 0;
    const availableTeamNumbers = [];
    const usedNames = new Set();
    const slotMap = new Map();
    const rarityOrder = ['UR', 'SSR', 'SR', 'R'];
    let pendingInsert = null;
    let selectorMode = 'eligible'; // æˆ– 'slot'
     const activeFilters = { rarity: null, attribute: null, roleType: null };
    /* === å¼¹çª—å†…éƒ¨ç­›é€‰çŠ¶æ€ === */
    const eligibleFilters = {
      role: 'all',        // all | adventurer | supporter
      rarity: null,
      attribute: null,
      roleType: null,
    };

    /************* â‘  é…ç½®ï¼šå®šä¹‰æ‰€æœ‰ç­›é€‰é€‰é¡¹ *****************/
const FILTER_CONFIG = {
  role: {
    popupOnly: true,                       // â† æ–°å¢
    labelKey: 'filterLabel',
    buttons: [
      { value: 'all',        textKey: 'allLabel'      },
      { value: 'adventurer', textKey: 'adventurerLabel' },
      { value: 'supporter',  textKey: 'supporterLabel' }
    ],
  },
  rarity: {                // ä»ç„¶ç”¨å›ºå®šæ–‡æœ¬
    labelKey: 'rarity',
    buttons: ['SR','SSR','UR'].map(v=>({value:v, text:v}))
  },

  attribute: {             // âœ ä½¿ç”¨ç¿»è¯‘é”®
    labelKey: 'attribute',
    buttons: ['FIRE','WIND','EARTH','ELECTRIC','WATER']
      .map(v=>({value:v, textKey:`attribute_${v}`}))
  },

  roleType: {              // âœ ä½¿ç”¨ç¿»è¯‘é”®
    labelKey: 'roleType',
    buttons: [
      { value:'ATTACK',  textKey:'roleType_ATTACK'  },
      { value:'DEFENSE', textKey:'roleType_DEFENSE' },
      { value:'SPEED',   textKey:'roleType_SPEED'   },
      { value:'SUPPORT', textKey:'roleType_SUPPORT' },
    ],
  },
};

/************* â‘¡ æ¸²æŸ“å‡½æ•°ï¼šä»»æ„å®¹å™¨ã€ä»»æ„ scope *********/
function renderFilterUI(targetId, scope){
  const isMain = scope === 'main';
  const container = document.getElementById(targetId);
  container.innerHTML = '';                              // æ¸…ç©º

  Object.entries(FILTER_CONFIG).forEach(([group, cfg])=>{
    if (cfg.popupOnly && isMain) return;   // ä¸»ç•Œé¢è·³è¿‡ role è¡Œ
    const row = document.createElement('div'); row.className = 'filter-row';

    // label
    const label = document.createElement('span');
    label.className='filter-label';
    label.dataset.tKey = cfg.labelKey;
    label.textContent = t(cfg.labelKey);
    row.appendChild(label);

    // buttons
    const btnBox = document.createElement('div'); btnBox.className='filter-buttons';
    cfg.buttons.forEach(btnCfg=>{
      const btn=document.createElement('button');
      btn.textContent = btnCfg.textKey ? t(btnCfg.textKey) : btnCfg.text;
      if (btnCfg.textKey) btn.dataset.tKey = btnCfg.textKey;
      btn.dataset.group = group;
      btn.dataset.value = btnCfg.value;
      btn.onclick = () => toggleFilterGeneric(scope, group, btnCfg.value);
      btnBox.appendChild(btn);
    });
    row.appendChild(btnBox);
    container.appendChild(row);
  });

  // é¢å¤–è¡Œï¼šé‡ç½® / Eligible åªåœ¨ä¸»ç•Œé¢å‡ºç°
  if(isMain){
    const extra = document.createElement('div'); extra.className='filter-row';
    extra.innerHTML = `
      <div class="filter-buttons full-width">
        <button onclick="resetFilters()" data-t-key="reset">${t('reset')}</button>
        <button onclick="openEligibleSelector()" data-t-key="eligible">${t('eligible')}</button>
      </div>`;
    container.appendChild(extra);
  }
}

/************* â‘¢ é€šç”¨åˆ‡æ¢å‡½æ•°ï¼ˆæ›¿æ¢ä»¥å‰ä¸¤ä¸ªå‡½æ•°ï¼‰ *********/
function toggleFilterGeneric(scope, type, val){
  const cfg = scope==='main'
    ? { state: activeFilters, render: renderPool,  selector:'#mainFilters' }
    : { state: eligibleFilters, render: renderEligibleList, selector:'#eligibleFiltersContainer' };

  cfg.state[type] = cfg.state[type]===val ? null : val;

  document.querySelectorAll(`${cfg.selector} [data-group="${type}"]`)
          .forEach(btn=>{
            btn.classList.toggle(
              'active',
              btn.dataset.value === cfg.state[type]
            );
          });

  cfg.render();
}


    // åˆ¤æ–­ä¸€ä¸ªè§’è‰²æ˜¯å¦åº”è¯¥æ˜¾ç¤º
    function filterFunc(char) {
      if (eligibleCharacters.size > 0 && !eligibleCharacters.has(char.name)) return false;
      if (activeFilters.rarity && char.rarity !== activeFilters.rarity) return false;
      if (activeFilters.attribute && char.attribute !== activeFilters.attribute) return false;
      if (activeFilters.roleType && char.roleType !== activeFilters.roleType) return false;
      return true;
    }

    // æŒ‰ç¨€æœ‰åº¦+åå­—æ’åº
    function sortFunc(a, b) {
      const ra = rarityOrder.indexOf(a.rarity), rb = rarityOrder.indexOf(b.rarity);
      if (ra !== rb) return ra - rb;
      return (a.baseName || a.name).localeCompare(b.baseName || b.name, currentLang);
    }

   document.addEventListener('DOMContentLoaded', ()=>{
  renderFilterUI('mainFilters','main');
  renderFilterUI('eligibleFiltersContainer','eligible');
  renderPool();
  loadFromLocal();
  document.getElementById('languageSelector').value = currentLang; 
  applyTranslations();
});

    function toggleFilter(type, value) {
      const prevValue = activeFilters[type];
      activeFilters[type] = prevValue === value ? null : value;

      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.querySelectorAll(`#filters button[data-type="${type}"]`).forEach(btn => {
        btn.classList.toggle("active", btn.dataset.value === activeFilters[type]);
      });

      renderPool();
    }
    function resetFilters() {
      activeFilters.rarity = null;
      activeFilters.attribute = null;
      activeFilters.roleType = null;
      renderPool();
    }

    function renderPool() {
      const advBox = document.getElementById("adventurers");
      const supBox = document.getElementById("supporters");
      advBox.innerHTML = "";
      supBox.innerHTML = "";

      // const filterFunc = char => {
      //    // âœ… æ²¡æœ‰è®¾ç½®æ—¶é»˜è®¤å…¨æ˜¾ç¤º
      //   if (eligibleCharacters.size > 0 && !eligibleCharacters.has(char.name)) return false;
      //   if (activeFilters.rarity   && char.rarity   !== activeFilters.rarity)   return false;
      //   if (activeFilters.attribute && char.attribute !== activeFilters.attribute) return false;
      //   if (activeFilters.roleType  && char.roleType  !== activeFilters.roleType)  return false;
      //   return true;
      // };

      // const sortFunc = (a, b) => {
      //   const ra = rarityOrder.indexOf(a.rarity);
      //   const rb = rarityOrder.indexOf(b.rarity);
      //   if (ra !== rb) return ra - rb;
      //   const nameA = (a.baseName || a.name).toString();
      //   const nameB = (b.baseName || b.name).toString();
      //   return nameA.localeCompare(nameB, 'zh');
      // };

      characters.adventurers
        .filter(filterFunc)
        .sort(sortFunc)
        .forEach(char => {
          char.role = "adventurer";
          advBox.appendChild(createCharacterEl(char));
        });

      characters.supporters
        .filter(filterFunc)
        .sort(sortFunc)
        .forEach(char => {
          char.role = "supporter";
          supBox.appendChild(createCharacterEl(char));
        });
    }

    function createCharacterEl(char) {
      const nameKey = char.name;
      const displayName = char.baseName || char.name;
      const el = document.createElement("div");
      el.className = "character";
      el.draggable = true;
      el.dataset.name = nameKey;
      el.dataset.img = char.img;
      el.dataset.role = char.role;
      el.innerHTML = `<img src="${char.img}" alt="${displayName}" title="${displayName}">`;
      el.addEventListener("dragstart", e => {
        e.dataTransfer.setData("text/plain", JSON.stringify({ name: nameKey, img: char.img, role: char.role, baseName: char.baseName }));
        el.classList.add("dragging");
      });
      el.addEventListener("dragend", () => el.classList.remove("dragging"));
      if (usedNames.has(nameKey)) el.classList.add("used");
      return el;
    }

    function createSlot(type) {
      const slot = document.createElement("div");
      slot.className = "slot";
      slot.dataset.type = type;
      slot.addEventListener("dragover", e => e.preventDefault());
      slot.addEventListener("drop", e => {
        e.preventDefault();
        const data = JSON.parse(e.dataTransfer.getData("text/plain"));
        if (type !== data.role) return;
        const nameKey = data.name;
        const displayName = data.baseName || data.name;

        const row = slot.closest(".team-row");
        const index = Array.from(row.children).indexOf(slot);
        const pairedSlot = row.children[type === "adventurer" ? index + 1 : index - 1];
        const pairedImg = pairedSlot.querySelector("img");
        if (pairedImg && pairedImg.alt.toLowerCase() === displayName.toLowerCase()) {
          // alert(`è¯¥å°ç»„ä¸­ä¸èƒ½å‡ºç°é‡å¤è§’è‰²ï¼š${displayName.replace(/_+/g,' ')}`);
          alert(t("conflictAlert", displayName.replace(/_+/g, ' ')));
          return;
        }

        const targetImg = slot.querySelector("img");
        const sourceSlot = slotMap.get(nameKey);
        if (targetImg) {
          const tgtKey = targetImg.getAttribute("data-name");
          const tgtData = { name: tgtKey, img: targetImg.src, role: type, baseName: targetImg.title };
          if (sourceSlot && sourceSlot !== slot) {
            setSlotImage(sourceSlot, tgtData);
            slotMap.set(tgtKey, sourceSlot);
          }
        } else if (sourceSlot && sourceSlot !== slot) {
          sourceSlot.innerHTML = "";
          slotMap.delete(nameKey);
        }

        // 1. å…ˆä¸´æ—¶æ”¾å…¥ slot
        setSlotImage(slot, data); // <--- è¿™ä¸€æ­¥åªåšä¸´æ—¶ï¼Œä¸è¦å…ˆ saveToLocalï¼

        // 2. æ£€æŸ¥æ‰€æœ‰é˜Ÿä¼æœ‰æ²¡æœ‰åŒç»„åŒå
        if (!checkAllTeamsNoConflict()) {
          // å†²çªï¼šæ’¤å›è¿™æ¬¡æ’å…¥
          slot.innerHTML = "";
          // alert("æ‹–æ‹½åä¼šå¯¼è‡´åŒç»„å‡ºç°é‡å¤è§’è‰²ï¼Œæ“ä½œè¢«å–æ¶ˆï¼");
          alert(t("dropConflict"));
          loadFromLocal();    // â† å½»åº•é‡åˆ·é˜Ÿä¼ï¼ˆä»æœ¬åœ°å­˜å‚¨æ¢å¤ï¼‰
          renderPool(); // åˆ·æ–°å›æ­£å¸¸
          return;
        }

        // 3. æ­£å¸¸æµç¨‹
        slotMap.set(nameKey, slot);

        usedNames.clear();
        slotMap.forEach((v, k) => usedNames.add(k));
        renderPool();
        saveToLocal();
      });
      slot.addEventListener("click", () => {
        const img = slot.querySelector("img");
        if (!img) return;
        const key = img.getAttribute("data-name");
        usedNames.delete(key);
        slotMap.delete(key);
        slot.innerHTML = "";
        renderPool();
        saveToLocal();
      });
      return slot;
    }

    function setSlotImage(slot, char) {
      const nameKey = char.name;
      const displayName = char.baseName || char.name;
      slot.innerHTML = "";
      const img = document.createElement("img");
      img.src = char.img;  // âœ… ç”¨åŸå§‹ç›¸å¯¹è·¯å¾„ï¼Œä¸æ”¹
      img.alt = displayName;
      img.title = displayName;
      img.setAttribute("data-name", nameKey);
      img.setAttribute("data-src", char.img); // âœ… åŠ ä¸ŠçœŸå®è·¯å¾„ï¼ˆç”¨äºå¯¼å‡ºï¼‰
      img.draggable = true;
      img.addEventListener("dragstart", e => {
        e.dataTransfer.setData("text/plain", JSON.stringify(char));
        img.classList.add("dragging");
      });
      img.addEventListener("dragend", () => img.classList.remove("dragging"));
      slot.appendChild(img);
    }


    function addTeam() {
      const teamNumber = availableTeamNumbers.length ? availableTeamNumbers.shift() : ++teamCounter;

      const wrapper = document.createElement("div");
      // wrapper.style.display = "flex";
      if (window.innerWidth <= 768) {
        wrapper.style.display = "block";
      } else {
        wrapper.style.display = "flex";
      }
      wrapper.style.alignItems = "stretch";

      const dragHandle = document.createElement("div");
      dragHandle.className = "drag-handle";
      dragHandle.setAttribute("draggable", "true");
      dragHandle.innerHTML = "â‰¡"; // ä½ ä¹Ÿå¯ä»¥ç”¨ iconï¼Œæˆ–è€…ç©ºç™½åŠ æ ·å¼
      wrapper.appendChild(dragHandle);
      // const container = document.createElement("div"); container.className = "team-container";
      const container = document.createElement("div");
      container.className = "team-container";
      container.draggable = true;
      wrapper.appendChild(container);
      addTeamDragEvents(wrapper); // åŠ å…¥æ‹–æ‹½äº‹ä»¶ç»‘å®š
      const header = document.createElement("div"); header.className = "team-header";
      const label = document.createElement("div"); label.className = "team-label";
      label.contentEditable = true; label.spellcheck = false;
      // label.textContent = `é˜Ÿä¼ ${teamNumber}`;
      label.textContent = t("team", teamNumber);
      label.dataset.defaultName = label.textContent;
      label.addEventListener("keypress", e => { if (e.key === "Enter") { e.preventDefault(); label.blur(); } });
      label.addEventListener("blur", () => { if (label.textContent.trim() === "") label.textContent = label.dataset.defaultName; saveToLocal(); });
      const controls = document.createElement("div");
      const clearBtn = document.createElement("button");
      clearBtn.setAttribute("data-t-key", "clear");
      clearBtn.textContent = t("clear");
      clearBtn.onclick = () => {
        if (!confirm(t("clearConfirm", label.textContent))) return;
        row.querySelectorAll(".slot").forEach(s => { const i = s.querySelector("img"); if (i) { usedNames.delete(i.getAttribute("data-name")); slotMap.delete(i.getAttribute("data-name")); s.innerHTML = ""; } });
        renderPool(); saveToLocal();
      };
      const deleteBtn = document.createElement("button");
      deleteBtn.setAttribute("data-t-key", "deleteTeam");
      deleteBtn.textContent = t("deleteTeam");
      deleteBtn.onclick = () => {
        // if(!confirm(`ç¡®å®šåˆ é™¤ ${label.textContent}?`)) return;
        if (!confirm(t("deleteConfirm", label.textContent))) return;
        container.querySelectorAll(".slot img").forEach(i => { usedNames.delete(i.getAttribute("data-name")); slotMap.delete(i.getAttribute("data-name")); });
        wrapper.remove();
        availableTeamNumbers.push(teamNumber); renderPool(); saveToLocal();
      };
      controls.appendChild(clearBtn); controls.appendChild(deleteBtn);
      header.appendChild(label); header.appendChild(controls);
      container.appendChild(header);
      const row = document.createElement("div"); row.className = "team-row";
      for (let i = 0; i < 3; i++) {
        row.appendChild(createSlot("adventurer"));
        row.appendChild(createSlot("supporter"));
      }
      container.appendChild(row);
      document.getElementById("teams").appendChild(wrapper);
      saveToLocal();
      applyTranslations();
    }

    function getCurrentData() {
      const teams = [];
      document.querySelectorAll("#teams > div").forEach(wrapper => {
        const container = wrapper.querySelector(".team-container");
        const name = container.querySelector(".team-label").textContent.trim(); // âœ… ç”¨ container æ›¿æ¢ c
        const row = container.querySelector(".team-row");
        const slots = row.querySelectorAll(".slot");
        const team = { name, adventurers: [], supporters: [] };
        slots.forEach(s => {
          const type = s.dataset.type;
          const img = s.querySelector("img");
          team[type + "s"].push(img ? {
            name: img.getAttribute("data-name"),
            img: img.getAttribute("data-src"),
            role: type,
            baseName: img.title
          } : null);
        });
        teams.push(team);
      });
      return teams;
    }

    function saveToLocal() { localStorage.setItem("savedTeams", JSON.stringify(getCurrentData())); }
    function loadFromLocal() { const d = localStorage.getItem("savedTeams"); if (d) renderFromData(JSON.parse(d)); }
    function exportConfig() {
      const data = {
        teams: getCurrentData(),
        eligibleCharacters: Array.from(eligibleCharacters),
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "team_config.json";
      a.click();
    }

    function importConfig(e) {
      const f = e.target.files[0];
      if (!f) return;
      const r = new FileReader();
      r.onload = ev => {
        const data = JSON.parse(ev.target.result);
        if (data.teams) renderFromData(data.teams);
        if (Array.isArray(data.eligibleCharacters)) {
          eligibleCharacters = new Set(data.eligibleCharacters);
          localStorage.setItem("eligibleCharacters", JSON.stringify(data.eligibleCharacters));
        }
        saveToLocal();
        renderPool();
      };
      r.readAsText(f);
    }

    function renderFromData(data) {
      document.getElementById("teams").innerHTML = "";
      usedNames.clear(); slotMap.clear(); availableTeamNumbers.length = 0; teamCounter = 0;

      data.forEach(team => {
        const num = ++teamCounter;

        const wrapper = document.createElement("div");
        // wrapper.style.display = "flex";
        if (window.innerWidth <= 768) {
          wrapper.style.display = "block";
        } else {
          wrapper.style.display = "flex";
        }
        wrapper.style.alignItems = "stretch";

        const dragHandle = document.createElement("div");
        dragHandle.className = "drag-handle";
        dragHandle.setAttribute("draggable", "true");
        dragHandle.innerHTML = "â‰¡";
        wrapper.appendChild(dragHandle);

        const container = document.createElement("div");
        container.className = "team-container";
        wrapper.appendChild(container);

        addTeamDragEvents(wrapper); // âœ… ä¿®æ­£ï¼šç»‘å®š wrapper è€Œä¸æ˜¯ container

        const header = document.createElement("div");
        header.className = "team-header";

        const label = document.createElement("div");
        label.className = "team-label";
        label.contentEditable = true;
        label.spellcheck = false;
        label.textContent = team.name;
        label.dataset.defaultName = team.name;
        label.addEventListener("keypress", e => {
          if (e.key === "Enter") { e.preventDefault(); label.blur(); }
        });
        label.addEventListener("blur", () => {
          if (label.textContent.trim() === "") label.textContent = label.dataset.defaultName;
          saveToLocal();
        });

        const controls = document.createElement("div");

        const clearBtn = document.createElement("button");
        // clearBtn.textContent = "æ¸…ç©º";
        clearBtn.setAttribute("data-t-key", "clear");
        clearBtn.textContent = t("clear");
        clearBtn.onclick = () => {
          // if (!confirm(`ç¡®å®šæ¸…ç©º ${label.textContent}?`)) return;
          if (!confirm(t("clearConfirm", label.textContent))) return;
          row.querySelectorAll(".slot").forEach(s => {
            const i = s.querySelector("img");
            if (i) {
              usedNames.delete(i.getAttribute("data-name"));
              slotMap.delete(i.getAttribute("data-name"));
              s.innerHTML = "";
            }
          });
          renderPool(); saveToLocal();
        };

        const deleteBtn = document.createElement("button");
        // deleteBtn.textContent = "åˆ é™¤é˜Ÿä¼";
        deleteBtn.setAttribute("data-t-key", "deleteTeam");
        deleteBtn.textContent = t("deleteTeam");
        deleteBtn.onclick = () => {
          // if (!confirm(`ç¡®å®šåˆ é™¤ ${label.textContent}?`)) return;
          if (!confirm(t("deleteConfirm", label.textContent))) return;
          container.querySelectorAll(".slot img").forEach(i => {
            usedNames.delete(i.getAttribute("data-name"));
            slotMap.delete(i.getAttribute("data-name"));
          });
          wrapper.remove(); // âœ… åˆ é™¤ wrapper è€Œé container
          availableTeamNumbers.push(num);
          renderPool(); saveToLocal();
        };

        controls.appendChild(clearBtn);
        controls.appendChild(deleteBtn);
        header.appendChild(label);
        header.appendChild(controls);
        container.appendChild(header);

        const row = document.createElement("div");
        row.className = "team-row";

        for (let i = 0; i < 3; i++) {
          const advSlot = createSlot("adventurer");
          const advData = team.adventurers[i];
          if (advData) {
            setSlotImage(advSlot, advData);
            slotMap.set(advData.name, advSlot);
            usedNames.add(advData.name);
          }
          row.appendChild(advSlot);

          const supSlot = createSlot("supporter");
          const supData = team.supporters[i];
          if (supData) {
            setSlotImage(supSlot, supData);
            slotMap.set(supData.name, supSlot);
            usedNames.add(supData.name);
          }
          row.appendChild(supSlot);
        }

        container.appendChild(row);
        document.getElementById("teams").appendChild(wrapper);
      });

      if (data.translations) {
        Object.assign(i18n, data.translations);
      }
      // â€”â€” å…³é”®ï¼šå¦‚æœå¸¦äº† languageï¼Œå°±è®¾ç½®å›æ¥
      if (data.language) {
        changeLanguage(data.language);
      }

      renderPool();
      applyTranslations();
    }

    let scrollTimer = null;

    document.addEventListener("dragover", (e) => {
      const SCROLL_MARGIN = 100;
      const BASE_SPEED = 20;
      const MAX_SPEED = 60;
      const y = e.clientY;
      const windowHeight = window.innerHeight;


      let direction = 0;
      let speed = 0;

      if (y < SCROLL_MARGIN) {
        direction = -1;
        speed = Math.min(MAX_SPEED, BASE_SPEED + (SCROLL_MARGIN - y) * 0.5);
      } else if (y > windowHeight - SCROLL_MARGIN) {
        direction = 1;
        speed = Math.min(MAX_SPEED, BASE_SPEED + (y - (windowHeight - SCROLL_MARGIN)) * 0.5);
      }

      if (direction !== 0) {
        if (!scrollTimer) {
          scrollTimer = setInterval(() => {
            window.scrollBy(0, direction * speed);
          }, 16); // æ¯å¸§æ»šåŠ¨
        }
      } else {
        if (scrollTimer) {
          clearInterval(scrollTimer);
          scrollTimer = null;
        }
      }
    });

    document.addEventListener("drop", () => {
      if (scrollTimer) {
        clearInterval(scrollTimer);
        scrollTimer = null;
      }
    });

    function checkAllTeamsNoConflict() {
      const teams = document.querySelectorAll("#teams > div");
      for (const wrapper of teams) {
        const row = wrapper.querySelector(".team-row");
        for (let i = 0; i < row.children.length; i += 2) {
          const adv = row.children[i]?.querySelector("img")?.getAttribute("alt")?.toLowerCase();
          const sup = row.children[i + 1]?.querySelector("img")?.getAttribute("alt")?.toLowerCase();
          if (adv && sup && adv === sup) {
            return false; // å­˜åœ¨åŒåï¼Œå†²çª
          }
        }
      }
      return true; // æ²¡å†²çª
    }


    function addTeamDragEvents(wrapper) {
      const dragHandle = wrapper.querySelector(".drag-handle");
      if (!dragHandle) return;

      dragHandle.addEventListener("dragstart", (e) => {
        wrapper.classList.add("dragging");
        e.dataTransfer.effectAllowed = "move";
        window.currentDraggingTeam = wrapper;
      });

      dragHandle.addEventListener("dragend", () => {
        wrapper.classList.remove("dragging");
        window.currentDraggingTeam = null;
      });

      let lastConflict = false;
      let dropTargetIndex = null;



      wrapper.addEventListener("dragleave", () => {
        wrapper.style.border = "";
      });
      wrapper.addEventListener("dragover", (e) => {
        e.preventDefault();
        const dragging = window.currentDraggingTeam;
        if (!dragging || dragging === wrapper) return;

        const bounding = wrapper.getBoundingClientRect();
        const offset = e.clientY - bounding.top;

        const parent = wrapper.parentNode;
        const refNode = offset > bounding.height / 2 ? wrapper.nextSibling : wrapper;

        // ä¿å­˜å¾…æ’å…¥çš„ç›®æ ‡ä½ç½®ï¼ˆæ‹–åŠ¨æ—¶ä¸ç«‹å³æ’å…¥ï¼‰
        pendingInsert = { parent, dragging, refNode };
      });

      wrapper.addEventListener("drop", () => {
        wrapper.style.border = "";

        if (!pendingInsert) return;

        const { parent, dragging, refNode } = pendingInsert;

        // æ¨¡æ‹Ÿæ’å…¥åçš„åˆ—è¡¨é¡ºåº
        const tempList = Array.from(parent.children);
        const oldIndex = tempList.indexOf(dragging);
        tempList.splice(oldIndex, 1);
        const newIndex = tempList.indexOf(refNode);
        tempList.splice(newIndex, 0, dragging);

        // æ£€æŸ¥æ’å…¥åçš„æ‰€æœ‰å°ç»„æ˜¯å¦å†²çª
        const conflict = tempList.some(wrap => {
          const row = wrap.querySelector(".team-row");
          for (let i = 0; i < row.children.length; i += 2) {
            const adv = row.children[i]?.querySelector("img")?.getAttribute("alt")?.toLowerCase();
            const sup = row.children[i + 1]?.querySelector("img")?.getAttribute("alt")?.toLowerCase();
            if (adv && sup && adv === sup) {
              return true;
            }
          }
          return false;
        });

        if (conflict) {
          alert("æ‹–æ‹½åä¼šå¯¼è‡´åŒç»„å‡ºç°é‡å¤è§’è‰²ï¼Œæ“ä½œè¢«å–æ¶ˆï¼");
          pendingInsert = null;
          return;
        }

        // âœ… æ— å†²çªæ‰æ‰§è¡Œæ’å…¥
        if (dragging !== refNode) {
          parent.insertBefore(dragging, refNode);
        }

        usedNames.clear();
        slotMap.clear();
        document.querySelectorAll("#teams .slot img").forEach(img => {
          const name = img.getAttribute("data-name");
          const slot = img.closest(".slot");
          if (name && slot) {
            usedNames.add(name);
            slotMap.set(name, slot);
          }
        });

        renderPool();
        saveToLocal();
        renderFromData(getCurrentData()); // âœ… å¼ºåˆ¶åˆ·æ–°ç»‘å®š
        pendingInsert = null;
      });




    }


    let eligibleCharacters = new Set(JSON.parse(localStorage.getItem("eligibleCharacters") || "[]"));

//     function setEligibleRole(role){
//   eligibleFilters.role = role;
//   document.querySelectorAll('#eligibleFilters [data-group="role"]')
//           .forEach(b=>b.classList.toggle('active', b.dataset.role===role));
//   renderEligibleList();
// }

// function toggleEligibleFilter(type,val){
//   eligibleFilters[type] = eligibleFilters[type]===val ? null : val;

//   /* åªåˆ·æ–°åŒç»„æŒ‰é’®çš„é«˜äº® */
//   document.querySelectorAll(`#eligibleFilters [data-group="${type}"]`)
//           .forEach(btn=>{
//             btn.classList.toggle('active',
//               (btn.textContent===val || btn.dataset.value===val) && eligibleFilters[type]);
//           });

//   renderEligibleList();
// }

function eligibleFilterFunc(c){
  if(eligibleFilters.role!=='all' && c.role!==eligibleFilters.role) return false;
  if(eligibleFilters.rarity   && c.rarity   !== eligibleFilters.rarity)   return false;
  if(eligibleFilters.attribute&& c.attribute!== eligibleFilters.attribute) return false;
  if(eligibleFilters.roleType && c.roleType !== eligibleFilters.roleType)  return false;
  return true;
}

function renderEligibleList(){
  const box=document.getElementById('eligibleList');
  box.innerHTML='';

  const arr=[
    ...(eligibleFilters.role!=='supporter'?  characters.adventurers:[]),
    ...(eligibleFilters.role!=='adventurer'? characters.supporters :[])
  ].filter(eligibleFilterFunc).sort(sortFunc);

  arr.forEach(char=>{
    const label=document.createElement('label');
    label.style.display='flex'; label.style.alignItems='center'; label.style.gap='6px';

    const cb=document.createElement('input');
    cb.type='checkbox'; cb.value=char.name;
    cb.checked=eligibleCharacters.has(char.name);
    cb.onchange=()=>{ cb.checked?eligibleCharacters.add(char.name):eligibleCharacters.delete(char.name);
                      localStorage.setItem('eligibleCharacters',JSON.stringify([...eligibleCharacters]));
                      renderPool(); };

    const img=new Image(); img.src=char.img; img.width=80; img.height=80;
    label.append(cb,img); box.append(label);
  });
}

// function openEligibleSelector(){
//   Object.assign(eligibleFilters,{role:'all',rarity:null,attribute:null,roleType:null});
//   document.querySelectorAll('#eligibleFilters button').forEach(b=>b.classList.remove('active'));
//   document.querySelector('#eligibleFilters [data-role="all"]').classList.add('active');
//   renderEligibleList();
//   document.getElementById('overlay').style.display='block';
//   document.getElementById('eligibleSelector').style.display='block';
// }
function openEligibleSelector(){
  Object.assign(eligibleFilters,{role:'all',rarity:null,attribute:null,roleType:null});

  // æ¸…é™¤æ‰€æœ‰æ¿€æ´»æ ·å¼
  document.querySelectorAll('#eligibleFiltersContainer button.active')
          .forEach(b=>b.classList.remove('active'));

  // é»˜è®¤ç‚¹äº® â€œå…¨éƒ¨â€
  document.querySelector('#eligibleFiltersContainer [data-value="all"]')
          .classList.add('active');

  renderEligibleList();
  document.getElementById('overlay').style.display='block';
  document.getElementById('eligibleSelector').style.display='block';
}


    function closeEligibleSelector() {
      document.getElementById("overlay").style.display = "none";
      document.getElementById("eligibleSelector").style.display = "none";
    }

    // function saveEligible() {
    //   const selected = Array.from(document.querySelectorAll("#eligibleList input:checked"))
    //     .map(el => el.value);
    //   eligibleCharacters = new Set(selected);
    //   localStorage.setItem("eligibleCharacters", JSON.stringify(selected));
    //   closeEligibleSelector();
    //   if (typeof renderPool === 'function') renderPool();
    // }
    // function toggleFilterPanel() {
    //   const filters = document.getElementById("filters");
    //   filters.classList.toggle("show");
    //   const btn = filters.querySelector(".toggle-filters");
    //   // btn.textContent = filters.classList.contains("show") ? "æ”¶èµ·ç­›é€‰" : "å±•å¼€ç­›é€‰";
    //   btn.textContent = filters.classList.contains("show")
    //     ? t("collapseFilter")
    //     : t("expandFilter");
    // }
    function toggleFilterPanel(){
      const box = document.getElementById('filters');
      box.classList.toggle('show');
      const btn = box.querySelector('.toggle-filters');
      btn.textContent = box.classList.contains('show')
        ? t('collapseFilter')
        : t('expandFilter');
    }

    // function openSlotSelector(slot) {
    //   const role = slot.dataset.type;                     // "adventurer" or "supporter"
    //   const titleKey = role === 'adventurer'
    //     ? 'adventurerLabel'
    //     : 'supporterLabel';

    //   // æ›´æ–°å¼¹çª—æ ‡é¢˜
    //   const h3 = document.querySelector('#eligibleSelector h3');
    //   h3.setAttribute('data-t-key', null);
    //   h3.textContent = t(titleKey);

    //   // ä» characters pool é‡Œç­›+æ’ï¼Œå†æ¸²æŸ“æŒ‰é’®
    //   const list = characters[role + 's']
    //     .filter(filterFunc)
    //     .sort(sortFunc);

    //   const container = document.getElementById('eligibleList');
    //   container.innerHTML = '';

    //   list.forEach(char => {
    //     const btn = document.createElement('button');
    //     btn.className = 'mobile-char-btn';
    //     // img å…ƒç´ 
    //     btn.innerHTML = `<img src="${char.img}" alt="${char.baseName || char.name}" 
    //                       title="${char.baseName || char.name}">`;

    //     if (usedNames.has(char.name)) {
    //       // å·²ç»åœ¨æŸä¸ªé˜Ÿä¼é‡Œï¼šç°æ‰å¹¶ç¦ç”¨
    //       btn.disabled = true;
    //       btn.classList.add('used');
    //     } else {
    //       // æ²¡è¢«é€‰è¿‡ï¼Œç‚¹å‡»å°±å¡«å…¥
    //       btn.onclick = () => {
    //         setSlotImage(slot, {
    //           name: char.name,
    //           img: char.img,
    //           baseName: char.baseName,
    //           role
    //         });
    //         usedNames.add(char.name);
    //         slotMap.set(char.name, slot);
    //         renderPool();    // æ›´æ–°å·¦ä¾§æˆ– PC æ± å­æ ·å¼
    //         saveToLocal();
    //         closeEligibleSelector();
    //       };
    //     }

    //     container.appendChild(btn);
    //   });

    //   // æ˜¾ç¤ºå¼¹çª—
    //   document.getElementById('overlay').style.display = 'block';
    //   document.getElementById('eligibleSelector').style.display = 'block';
    // }

    function openSlotSelector(slot) {
  const role = slot.dataset.type;                  // adventurer / supporter
  const row  = slot.closest('.team-row');
  const idx  = Array.from(row.children).indexOf(slot);
  const pair = row.children[role === 'adventurer' ? idx + 1 : idx - 1];

  // åŒç»„å¯¹é¢æ ¼å­çš„â€œæ˜¾ç¤ºåâ€ï¼ˆå’Œæ‹–æ‹½é€»è¾‘ä¿æŒä¸€è‡´ï¼‰
  const pairDisplay = pair.querySelector('img')?.getAttribute('alt')?.toLowerCase();

  // æ ‡é¢˜
  document.querySelector('#eligibleSelector h3')
          .textContent = t(role === 'adventurer' ? 'adventurerLabel' : 'supporterLabel');

  // è¿‡æ»¤ï¼šå…¨å±€ç­›é€‰ + æœªè¢« usedNames + æ˜¾ç¤ºåä¸èƒ½ç­‰äº pairDisplay
  const list = characters[role + 's']
      .filter(c =>
        filterFunc(c) &&
        !usedNames.has(c.name) &&
        ( (c.baseName || c.name).toLowerCase() !== pairDisplay )
      )
      .sort(sortFunc);

  const box = document.getElementById('eligibleList');
  box.innerHTML = '';

  list.forEach(char => {
    const btn = document.createElement('button');
    btn.className = 'mobile-char-btn';
    btn.innerHTML = `<img src="${char.img}" title="${char.baseName||char.name}">`;
    btn.onclick = () => {
      setSlotImage(slot, {
        name: char.name,
        img: char.img,
        baseName: char.baseName,
        role
      });
      usedNames.add(char.name);
      slotMap.set(char.name, slot);
      renderPool();
      saveToLocal();
      closeEligibleSelector();
    };
    box.appendChild(btn);
  });

  document.getElementById('overlay'        ).style.display = 'block';
  document.getElementById('eligibleSelector').style.display = 'block';
}


    window.addEventListener("DOMContentLoaded", () => {
      const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
      if (isMobile) {
        document.getElementById("teams").addEventListener("click", e => {
          const slot = e.target.closest(".slot");
          if (!slot) return;
          // å¦‚æœæ ¼å­é‡Œå·²ç»æœ‰ imgï¼Œå°±å¿½ç•¥ï¼ˆé™¤éä½ æƒ³æ”¯æŒæ¢äººï¼‰
          if (slot.querySelector("img")) return;
          openSlotSelector(slot);
        });
      }
    });



    let currentLang = localStorage.getItem("lang") || "zh";

    function t(key, ...args) {
      const str = i18n[currentLang][key];
      return typeof str === "function" ? str(...args) : str;
    }

    function changeLanguage(lang){
      currentLang = lang;
      localStorage.setItem('lang', lang);

      // â‘  åŒæ­¥ä¸‹æ‹‰æ¡†é€‰ä¸­é¡¹
      document.getElementById('languageSelector').value = lang;

      // â‘¡ é‡æ–°ç¿»è¯‘ç°æœ‰æ–‡æœ¬
      applyTranslations();
    }


    function applyTranslations() {
      const missing = [];

      // è®¾ç½®å•ä¸ªå…ƒç´ çš„æ–‡æœ¬
      function setText(selector, key) {
        const el = document.querySelector(selector);
        if (el) {
          el.textContent = t(key);
        } else {
          missing.push(`Missing element for selector: ${selector}`);
        }
      }

      // è®¾ç½®å¤šä¸ªå…·æœ‰ç›¸åŒ data-t-key çš„å…ƒç´ ï¼ˆç›´æ¥ç¿»è¯‘å…ƒç´ æœ¬èº«ï¼‰
      function setTextAll(key) {
        const els = document.querySelectorAll(`[data-t-key="${key}"]`);
        if (els.length === 0) {
          missing.push(`No elements with data-t-key="${key}"`);
        }
        els.forEach(el => {
          el.textContent = t(key);
        });
      }

      // è®¾ç½®å¤šä¸ªï¼Œä½†ç¿»è¯‘ç›®æ ‡æ˜¯å®ƒçš„å‰ä¸€ä¸ªå…„å¼Ÿå…ƒç´ ï¼ˆæ¯”å¦‚ label åœ¨å‰ï¼‰
      function setPreviousTextAll(key) {
        const els = document.querySelectorAll(`[data-t-key="${key}"]`);
        if (els.length === 0) {
          missing.push(`No elements with data-t-key="${key}"`);
        }
        els.forEach(el => {
          if (el.previousElementSibling) {
            el.previousElementSibling.textContent = t(key);
          } else {
            missing.push(`Element with data-t-key="${key}" has no previous sibling`);
          }
        });
      }

      // âœ… è®¾ç½®ä¸»è¦æ ‡é¢˜å’Œé™æ€ä½ç½®
      setText("h1", "title");
      setText(".filters-header strong", "filterLabel");

      // âœ… è®¾ç½®æ‰€æœ‰ data-t-key
      setTextAll("expandFilter");
      setTextAll("reset");
      setTextAll("eligible");
      setTextAll("addTeam");
      setTextAll("export");
      // setTextAll("save");
      // setTextAll("close");

      // âœ… è®¾ç½®é‚£äº›æ˜¯â€œæ ‡ç­¾çš„å‰ä¸€ä¸ªå…ƒç´ â€
      setTextAll("rarity");
      setTextAll("attribute");
      setTextAll("roleType");

      setTextAll("adventurerLabel");
      setTextAll("supporterLabel");
      setTextAll("teamBuilderLabel");
      setTextAll("setupYourPool");

      // setTextAll("collapseFilter");
      setTextAll("expandFilter");
      setTextAll("import");
      setTextAll("clear");
      setTextAll("deleteTeam");

      // setTextAll("clearConfirm");
      // setTextAll("deleteConfirm");
      // â‡’ æ‰€æœ‰å±æ€§ç­›é€‰æŒ‰é’®
      // document
      //   .querySelectorAll('button[data-type="attribute"]')
      //   .forEach(btn => {
      //     const val = btn.dataset.value;               // e.g. "FIRE"
      //     const key = `attribute_${val}`;              // å¯¹åº” i18n é‡Œçš„ attribute_FIRE
      //     btn.textContent = t(key);
      //   });

      // // â‡’ æ‰€æœ‰å®šä½ç­›é€‰æŒ‰é’®
      // document
      //   .querySelectorAll('button[data-type="roleType"]')
      //   .forEach(btn => {
      //     const val = btn.dataset.value;              // e.g. "ATTACK"
      //     const key = `roleType_${val}`;              // å¯¹åº” i18n é‡Œçš„ roleType_ATTACK
      //     btn.textContent = t(key);
      //   });
       // ç»Ÿä¸€åˆ·æ–°ä»»ä½•æ ‡æœ‰ data-t-key çš„å…ƒç´ ï¼ˆåŒ…å«åŠ¨æ€æ’å…¥çš„æŒ‰é’®ï¼‰
      document.querySelectorAll('[data-t-key]').forEach(el=>{
        const k = el.dataset.tKey;
        if(i18n[currentLang][k]) el.textContent = t(k);
      });

      // ğŸš¨ è¾“å‡ºç¼ºå¤±é¡¹
      if (missing.length > 0) {
        console.warn("âš ï¸ ä»¥ä¸‹å…ƒç´ æœªæ‰¾åˆ°æˆ–ç»“æ„å¼‚å¸¸ï¼š\n" + missing.join("\n"));
      }
    }

  </script>
</body>

</html>