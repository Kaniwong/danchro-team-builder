<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>è§’è‰²ç¼–é˜Ÿå·¥å…·</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f7f7f7; }
    h2 { margin-top: 30px; }
    .pool-group { margin-bottom: 20px; }
    .character-pool, .team-row {
      display: flex; flex-wrap: wrap; gap: 10px; margin: 10px 0;
    }
    .character, .slot {
      width: 80px; height: 80px; border: 2px dashed #ccc; border-radius: 10px;
      background-color: white; display: flex; align-items: center; justify-content: center;
      overflow: hidden;
    }
    .character img, .slot img { max-width: 100%; max-height: 100%; }
    .character.dragging { opacity: 0.5; }
    .used { opacity: 0.3; pointer-events: none; }
    .team-container {
      margin-bottom: 20px; padding: 10px; background: #fff;
      border: 1px solid #ccc; border-radius: 6px;
    }
    .team-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 10px;
    }
    .team-label { font-weight: bold; outline: none; }
    button { margin-left: 6px; cursor: pointer; }
    #filters button { margin-right: 4px; }
    .character-pool {
  max-height: 400px;
  overflow-y: auto;
  border: 1px solid #ccc;
  padding: 5px;
  background: #fff;
}
.team-container.dragging {
  opacity: 0.5;
  border: 2px dashed #888;
}
#overlay {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.4);
  display: none;
  z-index: 998;
}
#eligibleSelector {
  z-index: 999;
  width: 80%;
}
#eligibleList {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 10px;
}

  </style>
</head>
<body>
  <h1>è§’è‰²ç¼–é˜Ÿå·¥å…·</h1>

  <div id="filters">
    <strong>ç­›é€‰ï¼š</strong>
    ç¨€æœ‰åº¦ï¼š
    <button onclick="toggleFilter('rarity', 'SR')">SR</button>
    <button onclick="toggleFilter('rarity', 'SSR')">SSR</button>
    <button onclick="toggleFilter('rarity', 'UR')">UR</button>
    å±æ€§ï¼š
    <button onclick="toggleFilter('attribute', 'FIRE')">Fire</button>
    <button onclick="toggleFilter('attribute', 'WIND')">Wind</button>
    <button onclick="toggleFilter('attribute', 'EARTH')">Earth</button>
    <button onclick="toggleFilter('attribute', 'ELECTRIC')">Electric</button>
    <button onclick="toggleFilter('attribute', 'WATER')">Water</button>
    å®šä½ï¼š
    <button onclick="toggleFilter('roleType', 'ATTACK')">Attack</button>
    <button onclick="toggleFilter('roleType', 'DEFENSE')">Defense</button>
    <button onclick="toggleFilter('roleType', 'SPEED')">Speed</button>
    <button onclick="toggleFilter('roleType', 'SUPPORT')">Support</button>
    <button onclick="resetFilters()">é‡ç½®</button>
    <button onclick="openEligibleSelector()">ğŸ® è®¾ç½®å¯ä¸Šåœºè§’è‰²</button>
  </div>

  <!-- <div class="pool-group">
    <h2>å†’é™©è€…</h2>
    <div class="character-pool" id="adventurers"></div>
  </div>

  <div class="pool-group">
    <h2>æ”¯æ´è€…</h2>
    <div class="character-pool" id="supporters"></div>
  </div> -->
 <div id="overlay" onclick="closeEligibleSelector()"></div>
  
  <div id="eligibleSelector" style="display:none; background:#fff; border:1px solid #ccc; padding:10px; position:fixed; top:10%; left:50%; transform:translateX(-50%); max-height:80vh; overflow:auto; z-index:999;">
    <h3>è®¾ç½®ä½ çš„è§’è‰²æ± </h3>
    <div id="eligibleList"></div>
    <div style="margin-top: 15px;">
      <button onclick="saveEligible()">âœ… ä¿å­˜</button>
      <button onclick="closeEligibleSelector()">âŒ å…³é—­</button>
    </div>
  </div>


  <div style="display: flex; gap: 20px; align-items: flex-start;">
  <div style="flex: 2;">
    <div class="pool-group">
      <h2>å†’é™©è€…</h2>
      <div class="character-pool" id="adventurers"></div>
    </div>
    <div class="pool-group">
      <h2>æ”¯æ´è€…</h2>
      <div class="character-pool" id="supporters"></div>
    </div>
  </div>

  <div style="flex: 2;">
    <h2>é˜Ÿä¼ç¼–é˜Ÿ</h2>
    <div id="teams"></div>
    <div style="margin-top: 10px;">
      <button onclick="addTeam()">æ·»åŠ æ–°é˜Ÿä¼</button>
      <button onclick="exportConfig()">ğŸ“¤ å¯¼å‡º</button>
      <input type="file" accept="application/json" onchange="importConfig(event)" />
    </div>
  </div>
</div>

  <button onclick="addTeam()">æ·»åŠ æ–°é˜Ÿä¼</button>
  <button onclick="exportConfig()">ğŸ“¤ å¯¼å‡º</button>
  <input type="file" accept="application/json" onchange="importConfig(event)" />

  <script src="character-pool.js"></script>
  <script>
    let teamCounter = 0;
    const availableTeamNumbers = [];
    const usedNames = new Set();
    const slotMap = new Map();
    const activeFilters = { rarity: null, attribute: null, roleType: null };
    const rarityOrder = ['UR','SSR','SR','R'];

    window.addEventListener("DOMContentLoaded", () => {
      renderPool();
      loadFromLocal();
    });

    function toggleFilter(type, value) {
      activeFilters[type] = activeFilters[type] === value ? null : value;
      renderPool();
    }
    function resetFilters() {
      activeFilters.rarity = null;
      activeFilters.attribute = null;
      activeFilters.roleType = null;
      renderPool();
    }

    function renderPool() {
      const advBox = document.getElementById("adventurers");
      const supBox = document.getElementById("supporters");
      advBox.innerHTML = "";
      supBox.innerHTML = "";

      const filterFunc = char => {
         // âœ… æ²¡æœ‰è®¾ç½®æ—¶é»˜è®¤å…¨æ˜¾ç¤º
        if (eligibleCharacters.size > 0 && !eligibleCharacters.has(char.name)) return false;
        if (activeFilters.rarity   && char.rarity   !== activeFilters.rarity)   return false;
        if (activeFilters.attribute && char.attribute !== activeFilters.attribute) return false;
        if (activeFilters.roleType  && char.roleType  !== activeFilters.roleType)  return false;
        return true;
      };

      const sortFunc = (a, b) => {
        const ra = rarityOrder.indexOf(a.rarity);
        const rb = rarityOrder.indexOf(b.rarity);
        if (ra !== rb) return ra - rb;
        const nameA = (a.baseName || a.name).toString();
        const nameB = (b.baseName || b.name).toString();
        return nameA.localeCompare(nameB, 'zh');
      };

      characters.adventurers
        .filter(filterFunc)
        .sort(sortFunc)
        .forEach(char => {
          char.role = "adventurer";
          advBox.appendChild(createCharacterEl(char));
        });

      characters.supporters
        .filter(filterFunc)
        .sort(sortFunc)
        .forEach(char => {
          char.role = "supporter";
          supBox.appendChild(createCharacterEl(char));
        });
    }

    function createCharacterEl(char) {
      const nameKey = char.name;
      const displayName = char.baseName || char.name;
      const el = document.createElement("div");
      el.className   = "character";
      el.draggable   = true;
      el.dataset.name = nameKey;
      el.dataset.img  = char.img;
      el.dataset.role = char.role;
      el.innerHTML = `<img src="${char.img}" alt="${displayName}" title="${displayName}">`;
      el.addEventListener("dragstart", e => {
        e.dataTransfer.setData("text/plain", JSON.stringify({ name: nameKey, img: char.img, role: char.role, baseName: char.baseName }));
        el.classList.add("dragging");
      });
      el.addEventListener("dragend", () => el.classList.remove("dragging"));
      if (usedNames.has(nameKey)) el.classList.add("used");
      return el;
    }

    function createSlot(type) {
      const slot = document.createElement("div");
      slot.className = "slot";
      slot.dataset.type = type;
      slot.addEventListener("dragover", e => e.preventDefault());
      slot.addEventListener("drop", e => {
        e.preventDefault();
        const data = JSON.parse(e.dataTransfer.getData("text/plain"));
        if (type !== data.role) return;
        const nameKey = data.name;
        const displayName = data.baseName || data.name;

        const row = slot.closest(".team-row");
        const index = Array.from(row.children).indexOf(slot);
        const pairedSlot = row.children[type === "adventurer" ? index + 1 : index - 1];
        const pairedImg = pairedSlot.querySelector("img");
        if (pairedImg && pairedImg.alt.toLowerCase() === displayName.toLowerCase()) {
          alert(`è¯¥å°ç»„ä¸­ä¸èƒ½å‡ºç°é‡å¤è§’è‰²ï¼š${displayName.replace(/_+/g,' ')}`);
          return;
        }

        const targetImg = slot.querySelector("img");
        const sourceSlot = slotMap.get(nameKey);
        if (targetImg) {
          const tgtKey = targetImg.getAttribute("data-name");
          const tgtData = { name: tgtKey, img: targetImg.src, role: type, baseName: targetImg.title };
          if (sourceSlot && sourceSlot !== slot) {
            setSlotImage(sourceSlot, tgtData);
            slotMap.set(tgtKey, sourceSlot);
          }
        } else if (sourceSlot && sourceSlot !== slot) {
          sourceSlot.innerHTML = "";
          slotMap.delete(nameKey);
        }

        setSlotImage(slot, data);
        slotMap.set(nameKey, slot);

        usedNames.clear();
        slotMap.forEach((v, k) => usedNames.add(k));
        renderPool();
        saveToLocal();
      });
      slot.addEventListener("click", () => {
        const img = slot.querySelector("img");
        if (!img) return;
        const key = img.getAttribute("data-name");
        usedNames.delete(key);
        slotMap.delete(key);
        slot.innerHTML = "";
        renderPool();
        saveToLocal();
      });
      return slot;
    }

    function setSlotImage(slot, char) {
  const nameKey = char.name;
  const displayName = char.baseName || char.name;
  slot.innerHTML = "";
  const img = document.createElement("img");
  img.src = char.img;  // âœ… ç”¨åŸå§‹ç›¸å¯¹è·¯å¾„ï¼Œä¸æ”¹
  img.alt = displayName;
  img.title = displayName;
  img.setAttribute("data-name", nameKey);
  img.setAttribute("data-src", char.img); // âœ… åŠ ä¸ŠçœŸå®è·¯å¾„ï¼ˆç”¨äºå¯¼å‡ºï¼‰
  img.draggable = true;
  img.addEventListener("dragstart", e => {
    e.dataTransfer.setData("text/plain", JSON.stringify(char));
    img.classList.add("dragging");
  });
  img.addEventListener("dragend", () => img.classList.remove("dragging"));
  slot.appendChild(img);
}


    function addTeam() {
      const teamNumber = availableTeamNumbers.length ? availableTeamNumbers.shift() : ++teamCounter;
      // const container = document.createElement("div"); container.className = "team-container";
      const container = document.createElement("div");
      container.className = "team-container";
      container.draggable = true;
      addTeamDragEvents(container); // åŠ å…¥æ‹–æ‹½äº‹ä»¶ç»‘å®š
      const header = document.createElement("div"); header.className = "team-header";
      const label = document.createElement("div"); label.className = "team-label";
      label.contentEditable = true; label.spellcheck = false;
      label.textContent = `é˜Ÿä¼ ${teamNumber}`;
      label.dataset.defaultName = label.textContent;
      label.addEventListener("keypress", e => { if(e.key==="Enter"){ e.preventDefault(); label.blur(); }});
      label.addEventListener("blur", () => { if(label.textContent.trim()==="") label.textContent = label.dataset.defaultName; saveToLocal(); });
      const controls = document.createElement("div");
      const clearBtn = document.createElement("button"); clearBtn.textContent="æ¸…ç©º";
      clearBtn.onclick = () => {
        if(!confirm(`ç¡®å®šæ¸…ç©º ${label.textContent}?`)) return;
        row.querySelectorAll(".slot").forEach(s=>{const i=s.querySelector("img"); if(i){usedNames.delete(i.getAttribute("data-name")); slotMap.delete(i.getAttribute("data-name")); s.innerHTML="";}});
        renderPool(); saveToLocal();
      };
      const deleteBtn = document.createElement("button"); deleteBtn.textContent="åˆ é™¤é˜Ÿä¼";
      deleteBtn.onclick = () => {
        if(!confirm(`ç¡®å®šåˆ é™¤ ${label.textContent}?`)) return;
        container.querySelectorAll(".slot img").forEach(i=>{usedNames.delete(i.getAttribute("data-name")); slotMap.delete(i.getAttribute("data-name"));});
        container.remove(); availableTeamNumbers.push(teamNumber); renderPool(); saveToLocal();
      };
      controls.appendChild(clearBtn); controls.appendChild(deleteBtn);
      header.appendChild(label); header.appendChild(controls);
      container.appendChild(header);
      const row = document.createElement("div"); row.className="team-row";
      for(let i=0;i<3;i++){
        row.appendChild(createSlot("adventurer"));
        row.appendChild(createSlot("supporter"));
      }
      container.appendChild(row);
      document.getElementById("teams").appendChild(container);
      saveToLocal();
    }

    function getCurrentData(){
      const teams=[];
      document.querySelectorAll(".team-container").forEach(c=>{
        const name=c.querySelector(".team-label").textContent.trim();
        const row=c.querySelector(".team-row");
        const slots=row.querySelectorAll(".slot");
        const team={name, adventurers:[], supporters:[]};
        slots.forEach(s=>{
          const type=s.dataset.type;
          const img=s.querySelector("img");
          team[type + "s"].push(img ? {
  name: img.getAttribute("data-name"),
  img: img.getAttribute("data-src"),  // âœ… æ”¹è¿™é‡Œï¼Œä¸ç”¨ img.src
  role: type,
  baseName: img.title
} : null);
        });
        teams.push(team);
      });
      return teams;
    }
    function saveToLocal(){localStorage.setItem("savedTeams", JSON.stringify(getCurrentData()));}
    function loadFromLocal(){ const d=localStorage.getItem("savedTeams"); if(d)renderFromData(JSON.parse(d)); }
    function exportConfig() {
  const data = {
    teams: getCurrentData(),
    eligibleCharacters: Array.from(eligibleCharacters),
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "team_config.json";
  a.click();
}

    function importConfig(e) {
  const f = e.target.files[0];
  if (!f) return;
  const r = new FileReader();
  r.onload = ev => {
    const data = JSON.parse(ev.target.result);
    if (data.teams) renderFromData(data.teams);
    if (Array.isArray(data.eligibleCharacters)) {
      eligibleCharacters = new Set(data.eligibleCharacters);
      localStorage.setItem("eligibleCharacters", JSON.stringify(data.eligibleCharacters));
    }
    saveToLocal();
    renderPool();
  };
  r.readAsText(f);
}

    function renderFromData(data){
      document.getElementById("teams").innerHTML="";
      usedNames.clear(); slotMap.clear(); availableTeamNumbers.length=0; teamCounter=0;
      data.forEach(team=>{
        const num=++teamCounter;
        const container=document.createElement("div"); container.className="team-container";
        const header=document.createElement("div"); header.className="team-header";
        const label=document.createElement("div"); label.className="team-label"; label.contentEditable=true; label.spellcheck=false;
        label.textContent=team.name; label.dataset.defaultName=team.name;
        label.addEventListener("keypress",e=>{ if(e.key==="Enter"){ e.preventDefault(); label.blur(); }});
        label.addEventListener("blur",()=>{ if(label.textContent.trim()==="") label.textContent=label.dataset.defaultName; saveToLocal(); });
        const controls=document.createElement("div");
        const clearBtn=document.createElement("button"); clearBtn.textContent="æ¸…ç©º";
        clearBtn.onclick=()=>{
          if(!confirm(`ç¡®å®šæ¸…ç©º ${label.textContent}?`)) return;
          row.querySelectorAll(".slot").forEach(s=>{ const i=s.querySelector("img"); if(i){ usedNames.delete(i.getAttribute("data-name")); slotMap.delete(i.getAttribute("data-name")); s.innerHTML=""; }});
          renderPool(); saveToLocal();
        };
        const deleteBtn=document.createElement("button"); deleteBtn.textContent="åˆ é™¤é˜Ÿä¼";
        deleteBtn.onclick=()=>{
          if(!confirm(`ç¡®å®šåˆ é™¤ ${label.textContent}?`)) return;
          container.querySelectorAll(".slot img").forEach(i=>{ usedNames.delete(i.getAttribute("data-name")); slotMap.delete(i.getAttribute("data-name")); });
          container.remove(); availableTeamNumbers.push(num); renderPool(); saveToLocal();
        };
        controls.appendChild(clearBtn); controls.appendChild(deleteBtn);
        header.appendChild(label); header.appendChild(controls);
        container.appendChild(header);
        const row=document.createElement("div"); row.className="team-row";
        for(let i=0;i<3;i++){
          const advSlot=createSlot("adventurer"); const advData=team.adventurers[i]; if(advData){ setSlotImage(advSlot, advData); slotMap.set(advData.name, advSlot); usedNames.add(advData.name);} row.appendChild(advSlot);
          const supSlot=createSlot("supporter"); const supData=team.supporters[i]; if(supData){ setSlotImage(supSlot, supData); slotMap.set(supData.name, supSlot); usedNames.add(supData.name);} row.appendChild(supSlot);
        }
        container.appendChild(row);
        document.getElementById("teams").appendChild(container);
      });
      renderPool();
    }
    let scrollTimer = null;

document.addEventListener("dragover", (e) => {
  const SCROLL_MARGIN = 100;
  const BASE_SPEED = 20;
  const MAX_SPEED = 60;
  const y = e.clientY;
  const windowHeight = window.innerHeight;

  let direction = 0;
  let speed = 0;

  if (y < SCROLL_MARGIN) {
    direction = -1;
    speed = Math.min(MAX_SPEED, BASE_SPEED + (SCROLL_MARGIN - y) * 0.5);
  } else if (y > windowHeight - SCROLL_MARGIN) {
    direction = 1;
    speed = Math.min(MAX_SPEED, BASE_SPEED + (y - (windowHeight - SCROLL_MARGIN)) * 0.5);
  }

  if (direction !== 0) {
    if (!scrollTimer) {
      scrollTimer = setInterval(() => {
        window.scrollBy(0, direction * speed);
      }, 16); // æ¯å¸§æ»šåŠ¨
    }
  } else {
    if (scrollTimer) {
      clearInterval(scrollTimer);
      scrollTimer = null;
    }
  }
});

document.addEventListener("drop", () => {
  if (scrollTimer) {
    clearInterval(scrollTimer);
    scrollTimer = null;
  }
});
function addTeamDragEvents(container) {
  container.addEventListener("dragstart", (e) => {
    container.classList.add("dragging");
    e.dataTransfer.effectAllowed = "move";
    window.currentDraggingTeam = container;
  });

  container.addEventListener("dragend", () => {
    container.classList.remove("dragging");
    window.currentDraggingTeam = null;
  });

  container.addEventListener("dragover", (e) => {
    e.preventDefault();
    const dragging = window.currentDraggingTeam;
    if (!dragging || dragging === container) return;

    const bounding = container.getBoundingClientRect();
    const offset = e.clientY - bounding.top;

    const parent = container.parentNode;
    const refNode = offset > bounding.height / 2 ? container.nextSibling : container;

    if (dragging !== refNode) {
      parent.insertBefore(dragging, refNode);
    }
  });

  container.addEventListener("drop", () => {
    saveToLocal(); // æ‹–åŠ¨å®Œæˆåä¿å­˜é¡ºåº
  });
}

let eligibleCharacters = new Set(JSON.parse(localStorage.getItem("eligibleCharacters") || "[]"));

    function openEligibleSelector() {
      const container = document.getElementById("eligibleList");
      if (!container) {
        alert("æ‰¾ä¸åˆ° eligibleList å…ƒç´ ï¼Œè¯·æ£€æŸ¥ HTML æ˜¯å¦æ­£ç¡®æ’å…¥ï¼");
        return;
      }
      container.innerHTML = "";
      const allChars = [...(characters?.adventurers || []), ...(characters?.supporters || [])];
      allChars.sort((a, b) => (a.baseName || a.name).localeCompare(b.baseName || b.name, 'zh'));

      allChars.forEach(char => {
        const label = document.createElement("label");
        label.style.display = "flex";
        label.style.alignItems = "center";
        label.style.gap = "6px";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.value = char.name;
        checkbox.checked = eligibleCharacters.has(char.name);

        const img = document.createElement("img");
        img.src = char.img;
        img.alt = char.name;
        img.style.width = "80px";
        img.style.height = "80px";

        label.appendChild(checkbox);
        label.appendChild(img);
        // label.appendChild(document.createTextNode(char.baseName || char.name));
        container.appendChild(label);
      });

      document.getElementById("overlay").style.display = "block";
      document.getElementById("eligibleSelector").style.display = "block";
    }

    function closeEligibleSelector() {
      document.getElementById("overlay").style.display = "none";
      document.getElementById("eligibleSelector").style.display = "none";
    }

    function saveEligible() {
      const selected = Array.from(document.querySelectorAll("#eligibleList input:checked"))
        .map(el => el.value);
      eligibleCharacters = new Set(selected);
      localStorage.setItem("eligibleCharacters", JSON.stringify(selected));
      closeEligibleSelector();
      if (typeof renderPool === 'function') renderPool();
    }
  </script>
</body>
</html>