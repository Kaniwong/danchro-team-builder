<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>角色编队工具</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f7f7f7; }
    h2 { margin-top: 30px; }
    .pool-group { margin-bottom: 20px; }
    .character-pool, .team-row {
      display: flex; flex-wrap: wrap; gap: 10px; margin: 10px 0;
    }
    .character, .slot {
      width: 80px; height: 80px; border: 2px dashed #ccc; border-radius: 10px;
      background-color: white; display: flex; align-items: center; justify-content: center;
      overflow: hidden;
    }
    .character img, .slot img { max-width: 100%; max-height: 100%; }
    .character.dragging { opacity: 0.5; }
    .used { opacity: 0.3; pointer-events: none; }
    .team-container {
      margin-bottom: 20px; padding: 10px; background: #fff;
      border: 1px solid #ccc; border-radius: 6px;
    }
    .team-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 10px;
    }
    .team-label { font-weight: bold; outline: none; }
    button { margin-left: 6px; cursor: pointer; }
    #filters button { margin-right: 4px; }
    .character-pool {
  max-height: 400px;
  overflow-y: auto;
  border: 1px solid #ccc;
  padding: 5px;
  background: #fff;
}
.team-container.dragging {
  opacity: 0.5;
  border: 2px dashed #888;
}
.team-drag-handle {
  font-size: 18px;
  padding: 2px 6px;
  border-radius: 4px;
}
.team-drag-handle:hover {
  background-color: #eee;
}
.team-wrapper.dragging {
  opacity: 0.5;
  border: 2px dashed #888;
}

.team-drag-handle {
  width: 28px;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 20px;
  user-select: none;
  cursor: grab;
  padding: 4px;
  margin-right: 8px;
}

  </style>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

</head>
<body>
  <h1>角色编队工具</h1>

  <div id="filters">
    <strong>筛选：</strong>
    稀有度：
    <button onclick="toggleFilter('rarity', 'SR')">SR</button>
    <button onclick="toggleFilter('rarity', 'SSR')">SSR</button>
    <button onclick="toggleFilter('rarity', 'UR')">UR</button>
    属性：
    <button onclick="toggleFilter('attribute', 'FIRE')">Fire</button>
    <button onclick="toggleFilter('attribute', 'WIND')">Wind</button>
    <button onclick="toggleFilter('attribute', 'EARTH')">Earth</button>
    <button onclick="toggleFilter('attribute', 'ELECTRIC')">Electric</button>
    <button onclick="toggleFilter('attribute', 'WATER')">Water</button>
    定位：
    <button onclick="toggleFilter('roleType', 'ATTACK')">Attack</button>
    <button onclick="toggleFilter('roleType', 'DEFENSE')">Defense</button>
    <button onclick="toggleFilter('roleType', 'SPEED')">Speed</button>
    <button onclick="toggleFilter('roleType', 'SUPPORT')">Support</button>
    <button onclick="resetFilters()">重置</button>
  </div>

  <!-- <div class="pool-group">
    <h2>冒险者</h2>
    <div class="character-pool" id="adventurers"></div>
  </div>

  <div class="pool-group">
    <h2>支援者</h2>
    <div class="character-pool" id="supporters"></div>
  </div> -->

  <div style="display: flex; gap: 20px; align-items: flex-start;">
  <div style="flex: 1;">
    <div class="pool-group">
      <h2>冒险者</h2>
      <div class="character-pool" id="adventurers"></div>
    </div>
    <div class="pool-group">
      <h2>支援者</h2>
      <div class="character-pool" id="supporters"></div>
    </div>
  </div>

  <div style="flex: 1;">
    <h2>队伍编队</h2>
    <div id="teams"></div>
    <div style="margin-top: 10px;">
      <button onclick="addTeam()">添加新队伍</button>
      <button onclick="exportConfig()">📤 导出</button>
      <input type="file" accept="application/json" onchange="importConfig(event)" />
    </div>
  </div>
</div>

  <button onclick="addTeam()">添加新队伍</button>
  <button onclick="exportConfig()">📤 导出</button>
  <input type="file" accept="application/json" onchange="importConfig(event)" />

  <script src="character-pool.js"></script>
  <script>
    let teamCounter = 0;
    const availableTeamNumbers = [];
    const usedNames = new Set();
    const slotMap = new Map();
    const activeFilters = { rarity: null, attribute: null, roleType: null };
    const rarityOrder = ['UR','SSR','SR','R'];

    window.addEventListener("DOMContentLoaded", () => {
      renderPool();
      loadFromLocal();

      // 移动端 + 桌面拖拽支持队伍排序
      new Sortable(document.getElementById("teams"), {
        handle: ".team-drag-handle",
        animation: 150,
        onEnd: function () {
          saveToLocal(); // 拖拽结束后保存队伍顺序
        }
      });
    });

    function toggleFilter(type, value) {
      activeFilters[type] = activeFilters[type] === value ? null : value;
      renderPool();
    }
    function resetFilters() {
      activeFilters.rarity = null;
      activeFilters.attribute = null;
      activeFilters.roleType = null;
      renderPool();
    }

    function renderPool() {
      const advBox = document.getElementById("adventurers");
      const supBox = document.getElementById("supporters");
      advBox.innerHTML = "";
      supBox.innerHTML = "";

      const filterFunc = char => {
        if (activeFilters.rarity   && char.rarity   !== activeFilters.rarity)   return false;
        if (activeFilters.attribute && char.attribute !== activeFilters.attribute) return false;
        if (activeFilters.roleType  && char.roleType  !== activeFilters.roleType)  return false;
        return true;
      };

      const sortFunc = (a, b) => {
        const ra = rarityOrder.indexOf(a.rarity);
        const rb = rarityOrder.indexOf(b.rarity);
        if (ra !== rb) return ra - rb;
        const nameA = (a.baseName || a.name).toString();
        const nameB = (b.baseName || b.name).toString();
        return nameA.localeCompare(nameB, 'zh');
      };

      characters.adventurers
        .filter(filterFunc)
        .sort(sortFunc)
        .forEach(char => {
          char.role = "adventurer";
          advBox.appendChild(createCharacterEl(char));
        });

      characters.supporters
        .filter(filterFunc)
        .sort(sortFunc)
        .forEach(char => {
          char.role = "supporter";
          supBox.appendChild(createCharacterEl(char));
        });
    }

    function createCharacterEl(char) {
      const nameKey = char.name;
      const displayName = char.baseName || char.name;
      const el = document.createElement("div");
      el.className   = "character";
      el.draggable   = true;
      el.dataset.name = nameKey;
      el.dataset.img  = char.img;
      el.dataset.role = char.role;
      el.innerHTML = `<img src="${char.img}" alt="${displayName}" title="${displayName}">`;
      el.addEventListener("dragstart", e => {
        e.dataTransfer.setData("text/plain", JSON.stringify({ name: nameKey, img: char.img, role: char.role, baseName: char.baseName }));
        el.classList.add("dragging");
      });
      el.addEventListener("dragend", () => el.classList.remove("dragging"));
      if (usedNames.has(nameKey)) el.classList.add("used");
      return el;
    }

    function createSlot(type) {
      const slot = document.createElement("div");
      slot.className = "slot";
      slot.dataset.type = type;
      slot.addEventListener("dragover", e => e.preventDefault());
      slot.addEventListener("drop", e => {
        e.preventDefault();
        const data = JSON.parse(e.dataTransfer.getData("text/plain"));
        if (type !== data.role) return;
        const nameKey = data.name;
        const displayName = data.baseName || data.name;

        const row = slot.closest(".team-row");
        const index = Array.from(row.children).indexOf(slot);
        const pairedSlot = row.children[type === "adventurer" ? index + 1 : index - 1];
        const pairedImg = pairedSlot.querySelector("img");
        if (pairedImg && pairedImg.alt.toLowerCase() === displayName.toLowerCase()) {
          alert(`该小组中不能出现重复角色：${displayName.replace(/_+/g,' ')}`);
          return;
        }

        const targetImg = slot.querySelector("img");
        const sourceSlot = slotMap.get(nameKey);
        if (targetImg) {
          const tgtKey = targetImg.getAttribute("data-name");
          const tgtData = { name: tgtKey, img: targetImg.src, role: type, baseName: targetImg.title };
          if (sourceSlot && sourceSlot !== slot) {
            setSlotImage(sourceSlot, tgtData);
            slotMap.set(tgtKey, sourceSlot);
          }
        } else if (sourceSlot && sourceSlot !== slot) {
          sourceSlot.innerHTML = "";
          slotMap.delete(nameKey);
        }

        setSlotImage(slot, data);
        slotMap.set(nameKey, slot);

        usedNames.clear();
        slotMap.forEach((v, k) => usedNames.add(k));
        renderPool();
        saveToLocal();
      });
      slot.addEventListener("click", () => {
        const img = slot.querySelector("img");
        if (!img) return;
        const key = img.getAttribute("data-name");
        usedNames.delete(key);
        slotMap.delete(key);
        slot.innerHTML = "";
        renderPool();
        saveToLocal();
      });
      return slot;
    }

    function setSlotImage(slot, char) {
      const nameKey = char.name;
      const displayName = char.baseName || char.name;
      slot.innerHTML = "";
      const img = document.createElement("img");
      img.src = char.img;
      img.alt = displayName;
      img.title = displayName;
      img.setAttribute("data-name", nameKey);
      img.draggable = true;
      img.addEventListener("dragstart", e => {
        e.dataTransfer.setData("text/plain", JSON.stringify(char));
        img.classList.add("dragging");
      });
      img.addEventListener("dragend", () => img.classList.remove("dragging"));
      slot.appendChild(img);
    }

function addTeam() {
  const teamNumber = availableTeamNumbers.length ? availableTeamNumbers.shift() : ++teamCounter;

  const wrapper = document.createElement("div");
  wrapper.className = "team-wrapper";
  wrapper.style.display = "flex";
  wrapper.style.alignItems = "stretch";

  const dragHandle = document.createElement("div");
  dragHandle.className = "team-drag-handle";
  dragHandle.draggable = true;
  dragHandle.innerHTML = "⠿";
  dragHandle.addEventListener("dragstart", (e) => {
    wrapper.classList.add("dragging");
    e.dataTransfer.effectAllowed = "move";
    window.currentDraggingTeam = wrapper;
  });
  dragHandle.addEventListener("dragend", () => {
    wrapper.classList.remove("dragging");
    window.currentDraggingTeam = null;
  });

  const container = document.createElement("div");
  container.className = "team-container";
  // addTeamDragEvents(wrapper);

  const header = document.createElement("div");
  header.className = "team-header";

  const label = document.createElement("div");
  label.className = "team-label";
  label.contentEditable = true;
  label.spellcheck = false;
  label.textContent = `队伍 ${teamNumber}`;
  label.dataset.defaultName = label.textContent;
  label.addEventListener("keypress", e => { if (e.key === "Enter") { e.preventDefault(); label.blur(); } });
  label.addEventListener("blur", () => {
    if (label.textContent.trim() === "") label.textContent = label.dataset.defaultName;
    saveToLocal();
  });

  const controls = document.createElement("div");
  const clearBtn = document.createElement("button");
  clearBtn.textContent = "清空";
  clearBtn.onclick = () => {
    if (!confirm(`确定清空 ${label.textContent}?`)) return;
    row.querySelectorAll(".slot").forEach(s => {
      const i = s.querySelector("img");
      if (i) {
        usedNames.delete(i.getAttribute("data-name"));
        slotMap.delete(i.getAttribute("data-name"));
        s.innerHTML = "";
      }
    });
    renderPool(); saveToLocal();
  };

  const deleteBtn = document.createElement("button");
  deleteBtn.textContent = "删除队伍";
  deleteBtn.onclick = () => {
    if (!confirm(`确定删除 ${label.textContent}?`)) return;
    container.querySelectorAll(".slot img").forEach(i => {
      usedNames.delete(i.getAttribute("data-name"));
      slotMap.delete(i.getAttribute("data-name"));
    });
    wrapper.remove();
    availableTeamNumbers.push(teamNumber);
    renderPool(); saveToLocal();
  };

  controls.appendChild(clearBtn);
  controls.appendChild(deleteBtn);
  header.appendChild(label);
  header.appendChild(controls);
  container.appendChild(header);

  const row = document.createElement("div");
  row.className = "team-row";
  for (let i = 0; i < 3; i++) {
    row.appendChild(createSlot("adventurer"));
    row.appendChild(createSlot("supporter"));
  }
  container.appendChild(row);

  wrapper.appendChild(dragHandle);
  wrapper.appendChild(container);
  document.getElementById("teams").appendChild(wrapper);
  saveToLocal();
}

    function getCurrentData(){
      const teams=[];
      document.querySelectorAll(".team-container").forEach(c=>{
        const name=c.querySelector(".team-label").textContent.trim();
        const row=c.querySelector(".team-row");
        const slots=row.querySelectorAll(".slot");
        const team={name, adventurers:[], supporters:[]};
        slots.forEach(s=>{
          const type=s.dataset.type;
          const img=s.querySelector("img");
          team[type+"s"].push(img?{name:img.getAttribute("data-name"), img:img.src, role: type, baseName: img.title}:null);
        });
        teams.push(team);
      });
      return teams;
    }
    function saveToLocal(){localStorage.setItem("savedTeams", JSON.stringify(getCurrentData()));}
    function loadFromLocal(){ const d=localStorage.getItem("savedTeams"); if(d)renderFromData(JSON.parse(d)); }
    function exportConfig(){ const blob=new Blob([JSON.stringify(getCurrentData(),null,2)],{type:"application/json"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="team_config.json"; a.click(); }
    function importConfig(e){ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=ev=>{ renderFromData(JSON.parse(ev.target.result)); saveToLocal(); }; r.readAsText(f); }
    function renderFromData(data) {
  document.getElementById("teams").innerHTML = "";
  usedNames.clear(); slotMap.clear(); availableTeamNumbers.length = 0; teamCounter = 0;

  data.forEach(team => {
    const num = ++teamCounter;

    const wrapper = document.createElement("div");
    wrapper.className = "team-wrapper";
    wrapper.style.display = "flex";
    wrapper.style.alignItems = "stretch";

    const dragHandle = document.createElement("div");
    dragHandle.className = "team-drag-handle";
    dragHandle.draggable = true;
    dragHandle.innerHTML = "⠿";
    dragHandle.addEventListener("dragstart", (e) => {
      wrapper.classList.add("dragging");
      e.dataTransfer.effectAllowed = "move";
      window.currentDraggingTeam = wrapper;
    });
    dragHandle.addEventListener("dragend", () => {
      wrapper.classList.remove("dragging");
      window.currentDraggingTeam = null;
    });

    const container = document.createElement("div");
    container.className = "team-container";
    // addTeamDragEvents(wrapper);

    const header = document.createElement("div");
    header.className = "team-header";

    const label = document.createElement("div");
    label.className = "team-label";
    label.contentEditable = true;
    label.spellcheck = false;
    label.textContent = team.name;
    label.dataset.defaultName = team.name;
    label.addEventListener("keypress", e => { if (e.key === "Enter") { e.preventDefault(); label.blur(); } });
    label.addEventListener("blur", () => {
      if (label.textContent.trim() === "") label.textContent = label.dataset.defaultName;
      saveToLocal();
    });

    const controls = document.createElement("div");
    const clearBtn = document.createElement("button");
    clearBtn.textContent = "清空";
    clearBtn.onclick = () => {
      if (!confirm(`确定清空 ${label.textContent}?`)) return;
      row.querySelectorAll(".slot").forEach(s => {
        const i = s.querySelector("img");
        if (i) {
          usedNames.delete(i.getAttribute("data-name"));
          slotMap.delete(i.getAttribute("data-name"));
          s.innerHTML = "";
        }
      });
      renderPool(); saveToLocal();
    };

    const deleteBtn = document.createElement("button");
    deleteBtn.textContent = "删除队伍";
    deleteBtn.onclick = () => {
      if (!confirm(`确定删除 ${label.textContent}?`)) return;
      container.querySelectorAll(".slot img").forEach(i => {
        usedNames.delete(i.getAttribute("data-name"));
        slotMap.delete(i.getAttribute("data-name"));
      });
      wrapper.remove();
      availableTeamNumbers.push(num);
      renderPool(); saveToLocal();
    };

    controls.appendChild(clearBtn);
    controls.appendChild(deleteBtn);
    header.appendChild(label);
    header.appendChild(controls);
    container.appendChild(header);

    const row = document.createElement("div");
    row.className = "team-row";
    for (let i = 0; i < 3; i++) {
      const advSlot = createSlot("adventurer");
      const advData = team.adventurers[i];
      if (advData) {
        setSlotImage(advSlot, advData);
        slotMap.set(advData.name, advSlot);
        usedNames.add(advData.name);
      }
      row.appendChild(advSlot);

      const supSlot = createSlot("supporter");
      const supData = team.supporters[i];
      if (supData) {
        setSlotImage(supSlot, supData);
        slotMap.set(supData.name, supSlot);
        usedNames.add(supData.name);
      }
      row.appendChild(supSlot);
    }

    container.appendChild(row);
    wrapper.appendChild(dragHandle);
    wrapper.appendChild(container);
    document.getElementById("teams").appendChild(wrapper);
  });

  renderPool();
}

    let scrollTimer = null;

document.addEventListener("dragover", (e) => {
  const SCROLL_MARGIN = 100;
  const BASE_SPEED = 20;
  const MAX_SPEED = 60;
  const y = e.clientY;
  const windowHeight = window.innerHeight;

  let direction = 0;
  let speed = 0;

  if (y < SCROLL_MARGIN) {
    direction = -1;
    speed = Math.min(MAX_SPEED, BASE_SPEED + (SCROLL_MARGIN - y) * 0.5);
  } else if (y > windowHeight - SCROLL_MARGIN) {
    direction = 1;
    speed = Math.min(MAX_SPEED, BASE_SPEED + (y - (windowHeight - SCROLL_MARGIN)) * 0.5);
  }

  if (direction !== 0) {
    if (!scrollTimer) {
      scrollTimer = setInterval(() => {
        window.scrollBy(0, direction * speed);
      }, 16); // 每帧滚动
    }
  } else {
    if (scrollTimer) {
      clearInterval(scrollTimer);
      scrollTimer = null;
    }
  }
});

document.addEventListener("drop", () => {
  if (scrollTimer) {
    clearInterval(scrollTimer);
    scrollTimer = null;
  }
});
// function addTeamDragEvents(container) {
//   container.addEventListener("dragstart", (e) => {
//     container.classList.add("dragging");
//     e.dataTransfer.effectAllowed = "move";
//     window.currentDraggingTeam = container;
//   });

//   container.addEventListener("dragend", () => {
//     container.classList.remove("dragging");
//     window.currentDraggingTeam = null;
//   });

//   container.addEventListener("dragover", (e) => {
//     e.preventDefault();
//     const dragging = window.currentDraggingTeam;
//     if (!dragging || dragging === container) return;

//     const bounding = container.getBoundingClientRect();
//     const offset = e.clientY - bounding.top;

//     const parent = container.parentNode;
//     const refNode = offset > bounding.height / 2 ? container.nextSibling : container;

//     if (dragging !== refNode) {
//       parent.insertBefore(dragging, refNode);
//     }
//   });

//   container.addEventListener("drop", () => {
//     saveToLocal(); // 拖动完成后保存顺序
//   });
// }


  </script>
</body>
</html>