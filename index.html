<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è§’è‰²ç¼–é˜Ÿå·¥å…·</title>
  <style>
body {
  font-family: sans-serif;
  padding: 20px;
  background: #f7f7f7;
}
h1 {
  font-size: 24px;
}
h2 {
  margin-top: 30px;
  font-size: 20px;
}
.pool-group {
  margin-bottom: 20px;
}
.character-pool,
.team-row {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin: 10px 0;
}
.character,
.slot {
  width: 80px;
  height: 80px;
  border: 2px dashed #ccc;
  border-radius: 10px;
  background-color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  box-sizing: border-box;
}
.character img,
.slot img {
  max-width: 100%;
  max-height: 100%;
}
.character.dragging {
  opacity: 0.5;
}
.used {
  opacity: 0.3;
  pointer-events: none;
}
.team-container {
  margin-bottom: 20px;
  padding: 10px;
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 6px;
}
.team-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  flex-wrap: wrap;
}
.team-label {
  font-weight: bold;
  outline: none;
}
button {
  margin-left: 6px;
  cursor: pointer;
}
#filters button {
  margin-right: 4px;
}
.character-pool {
  max-height: 400px;
  overflow-y: auto;
  border: 1px solid #ccc;
  padding: 5px;
  background: #fff;
}
.team-container.dragging {
  opacity: 0.5;
  border: 2px dashed #888;
}
#overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.4);
  display: none;
  z-index: 998;
}
#eligibleSelector {
  z-index: 999;
  width: 80%;
}
#eligibleList {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  gap: 10px;
}
#filters button.active {
  background: #007bff;
  color: white;
  border: 2px solid #0056b3;
}
.drag-handle {
  width: 28px;
  height: 100%;
  min-width: 18px;
  min-height: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: grab;
  background: none;
  border: none;
  padding: 0 2px;
  margin-right: 10px;
  opacity: 0.65;
  transition: background 0.2s, box-shadow 0.2s, opacity 0.2s;
  user-select: none;
  z-index: 2;
}
.drag-handle:hover,
.drag-handle:active,
.drag-handle:focus {
  background: #eaf4ff;
  box-shadow: 0 2px 8px #007bff22;
  opacity: 1;
}
.drag-handle svg {
  display: block;
  width: 18px;
  height: 18px;
}
.dragging {
  opacity: 0.7;
  box-shadow: 0 4px 16px #007bff33;
}
.chosen {
  border: 2px solid #007bff;
}

/* ä¸»åŒºåŸŸå¸ƒå±€ */
#main-layout {
  display: flex;
  gap: 20px;
  align-items: flex-start;
  flex-wrap: wrap;
}

/* âœ… ç§»åŠ¨ç«¯ä¼˜åŒ– */
@media (max-width: 768px) {
  body {
    padding: 0;
  }

  h1 {
    font-size: 20px;
  }

  h2 {
    font-size: 16px;
    margin-top: 16px;
  }

  #main-layout {
    flex-direction: column;
    gap: 12px;
  }

  #main-layout > div {
    width: 100% !important;
    flex: none !important;
  }

  /* å›¾æ ‡ç¼©å° */
  .character,
  .slot {
    width: 50px;
    height: 50px;
  }

  .character-pool,
  .team-row {
    gap: 6px;
    justify-content: center;
  }

  /* æ ‡é¢˜å­—ä½“ */
  .team-label {
    font-size: 14px;
    max-width: 60%;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
  }

  /* æŒ‰é’®ç´§å‡‘ */
  .team-header button {
    font-size: 12px;
    padding: 1px 5px;
    margin-left: 4px;
  }

  /* ç­›é€‰æ¡æ»šåŠ¨ */
  #filters {
    overflow-x: auto;
    white-space: nowrap;
    padding-bottom: 8px;
    font-size: 16px;
    margin-bottom: 0;
  }

  #filters button {
    display: inline-block;
    font-size: 13px;
    padding: 4px 8px;
  }

  #eligibleSelector {
    width: 95% !important;
    max-height: 85vh;
    top: 5%;
    left: 50%;
    transform: translateX(-50%);
    padding: 10px;
    font-size: 14px;
  }

  #eligibleList img {
    width: 48px;
    height: 48px;
  }

  .character-pool {
    max-height: 240px;
    padding: 4px;
  }

  .team-container {
    padding: 6px;
    padding-bottom: 0;
    margin-bottom: 5px;
  }
  .drag-handle {
    justify-content: flex-start;
}
}
.team-controls {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 10px;
  align-items: center;
}

/* âœ… ç§»åŠ¨ç«¯æ ·å¼ä¼˜åŒ– */
@media (max-width: 768px) {
  .team-controls {
    flex-direction: column;
    align-items: stretch;
  }

  .team-controls button,
  .team-controls input[type="file"] {
    font-size: 15px;
    padding: 0;
    width: 100%;
    margin: 0;
  }
}

.filters {
  margin-bottom: 12px;
}

.filters-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
}

.toggle-filters {
  font-size: 14px;
  padding: 4px 10px;
}

.filters-body {
  display: none;
  flex-direction: column;
  gap: 8px;
}

.filters.show .filters-body {
    display: flex;
  }

.filter-row {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
}

.filter-label {
  flex: 0 0 70px;
  font-weight: bold;
  margin-bottom: 4px;
}

.filter-buttons {
  flex: 1;
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

.filter-buttons.full-width {
  width: 100%;
  justify-content: center;
  gap: 12px;
  margin-left: 0; /* å»é™¤ä¹‹å‰çš„ left margin */
}


/* âœ… ç§»åŠ¨ç«¯ä¼˜åŒ– */
@media (max-width: 768px) {
  .filter-label {
    flex: 0 0 64px;
    font-size: 14px;
  }

  .filter-buttons.full-width {
    margin-top: 10px;
}

  .filter-buttons button {
    font-size: 13px;
    padding: 4px 8px;
  }

  .toggle-filters {
    font-size: 13px;
  }

  /* .filters-body {
    display: none;
  } */

  
}


  </style>
</head>
<body>
  <h1>è§’è‰²ç¼–é˜Ÿå·¥å…·</h1>

<div id="filters" class="filters">
  <div class="filters-header">
    <strong>ç­›é€‰ï¼š</strong>
    <button class="toggle-filters" onclick="toggleFilterPanel()">å±•å¼€ç­›é€‰</button>
  </div>
  <div class="filters-body">
    <div class="filter-row">
      <span class="filter-label">ç¨€æœ‰åº¦ï¼š</span>
      <div class="filter-buttons">
        <button onclick="toggleFilter('rarity', 'SR')" data-type="rarity" data-value="SR">SR</button>
        <button onclick="toggleFilter('rarity', 'SSR')" data-type="rarity" data-value="SSR">SSR</button>
        <button onclick="toggleFilter('rarity', 'UR')" data-type="rarity" data-value="UR">UR</button>
      </div>
    </div>
    <div class="filter-row">
      <span class="filter-label">å±æ€§ï¼š</span>
      <div class="filter-buttons">
        <button onclick="toggleFilter('attribute', 'FIRE')" data-type="attribute" data-value="FIRE">Fire</button>
        <button onclick="toggleFilter('attribute', 'WIND')" data-type="attribute" data-value="WIND">Wind</button>
        <button onclick="toggleFilter('attribute', 'EARTH')" data-type="attribute" data-value="EARTH">Earth</button>
        <button onclick="toggleFilter('attribute', 'ELECTRIC')" data-type="attribute" data-value="ELECTRIC">Electric</button>
        <button onclick="toggleFilter('attribute', 'WATER')" data-type="attribute" data-value="WATER">Water</button>
      </div>
    </div>
    <div class="filter-row">
      <span class="filter-label">å®šä½ï¼š</span>
      <div class="filter-buttons">
        <button onclick="toggleFilter('roleType', 'ATTACK')" data-type="roleType" data-value="ATTACK">Attack</button>
        <button onclick="toggleFilter('roleType', 'DEFENSE')" data-type="roleType" data-value="DEFENSE">Defense</button>
        <button onclick="toggleFilter('roleType', 'SPEED')" data-type="roleType" data-value="SPEED">Speed</button>
        <button onclick="toggleFilter('roleType', 'SUPPORT')" data-type="roleType" data-value="SUPPORT">Support</button>
      </div>
    </div>
    <div class="filter-row">
      <div class="filter-buttons full-width">
        <button onclick="resetFilters()">é‡ç½®</button>
        <button onclick="openEligibleSelector()">ğŸ® è®¾ç½®å¯ä¸Šåœºè§’è‰²</button>
      </div>
    </div>
  </div>
</div>


  <!-- <div class="pool-group">
    <h2>å†’é™©è€…</h2>
    <div class="character-pool" id="adventurers"></div>
  </div>

  <div class="pool-group">
    <h2>æ”¯æ´è€…</h2>
    <div class="character-pool" id="supporters"></div>
  </div> -->
 <div id="overlay" onclick="closeEligibleSelector()"></div>
  
  <div id="eligibleSelector" style="display:none; background:#fff; border:1px solid #ccc; padding:10px; position:fixed; top:10%; left:50%; transform:translateX(-50%); max-height:80vh; overflow:auto; z-index:999;">
    <h3>è®¾ç½®ä½ çš„è§’è‰²æ± </h3>
    <div id="eligibleList"></div>
    <div style="margin-top: 15px;">
      <button onclick="saveEligible()">âœ… ä¿å­˜</button>
      <button onclick="closeEligibleSelector()">âŒ å…³é—­</button>
    </div>
  </div>


  <div id="main-layout">
  <div style="flex: 2;">
    <div class="pool-group">
      <h2>å†’é™©è€…</h2>
      <div class="character-pool" id="adventurers"></div>
    </div>
    <div class="pool-group">
      <h2>æ”¯æ´è€…</h2>
      <div class="character-pool" id="supporters"></div>
    </div>
  </div>

  <div style="flex: 2;">
    <h2>é˜Ÿä¼ç¼–é˜Ÿ</h2>
    <div id="teams"></div>
    <div class="team-controls" style="margin-top: 10px;">
      <button onclick="addTeam()">æ·»åŠ æ–°é˜Ÿä¼</button>
      <button onclick="exportConfig()">ğŸ“¤ å¯¼å‡º</button>
      <input type="file" accept="application/json" onchange="importConfig(event)" />
    </div>
  </div>
</div>

<script src="https://unpkg.com/drag-drop-touch/DragDropTouch.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
<script>
new Sortable(document.getElementById('teams'), {
  animation: 180,
  handle: '.drag-handle',
  ghostClass: 'dragging',
  chosenClass: 'chosen',
  onEnd: function (evt) {
    // evt.oldIndex, evt.newIndexï¼Œé˜Ÿä¼é¡ºåºå·²è‡ªåŠ¨è°ƒæ•´
    saveToLocal(); // è‡ªå·±çš„å­˜å‚¨é€»è¾‘
  }
});
</script>
  <script src="character-pool.js"></script>
  <script>
    let teamCounter = 0;
    const availableTeamNumbers = [];
    const usedNames = new Set();
    const slotMap = new Map();
    const activeFilters = { rarity: null, attribute: null, roleType: null };
    const rarityOrder = ['UR','SSR','SR','R'];
    let pendingInsert = null;

    window.addEventListener("DOMContentLoaded", () => {
      renderPool();
      loadFromLocal();
    });

    function toggleFilter(type, value) {
      const prevValue = activeFilters[type];
      activeFilters[type] = prevValue === value ? null : value;

      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.querySelectorAll(`#filters button[data-type="${type}"]`).forEach(btn => {
        btn.classList.toggle("active", btn.dataset.value === activeFilters[type]);
      });

      renderPool();
    }
    function resetFilters() {
      activeFilters.rarity = null;
      activeFilters.attribute = null;
      activeFilters.roleType = null;
      renderPool();
    }

    function renderPool() {
      const advBox = document.getElementById("adventurers");
      const supBox = document.getElementById("supporters");
      advBox.innerHTML = "";
      supBox.innerHTML = "";

      const filterFunc = char => {
         // âœ… æ²¡æœ‰è®¾ç½®æ—¶é»˜è®¤å…¨æ˜¾ç¤º
        if (eligibleCharacters.size > 0 && !eligibleCharacters.has(char.name)) return false;
        if (activeFilters.rarity   && char.rarity   !== activeFilters.rarity)   return false;
        if (activeFilters.attribute && char.attribute !== activeFilters.attribute) return false;
        if (activeFilters.roleType  && char.roleType  !== activeFilters.roleType)  return false;
        return true;
      };

      const sortFunc = (a, b) => {
        const ra = rarityOrder.indexOf(a.rarity);
        const rb = rarityOrder.indexOf(b.rarity);
        if (ra !== rb) return ra - rb;
        const nameA = (a.baseName || a.name).toString();
        const nameB = (b.baseName || b.name).toString();
        return nameA.localeCompare(nameB, 'zh');
      };

      characters.adventurers
        .filter(filterFunc)
        .sort(sortFunc)
        .forEach(char => {
          char.role = "adventurer";
          advBox.appendChild(createCharacterEl(char));
        });

      characters.supporters
        .filter(filterFunc)
        .sort(sortFunc)
        .forEach(char => {
          char.role = "supporter";
          supBox.appendChild(createCharacterEl(char));
        });
    }

    function createCharacterEl(char) {
      const nameKey = char.name;
      const displayName = char.baseName || char.name;
      const el = document.createElement("div");
      el.className   = "character";
      el.draggable   = true;
      el.dataset.name = nameKey;
      el.dataset.img  = char.img;
      el.dataset.role = char.role;
      el.innerHTML = `<img src="${char.img}" alt="${displayName}" title="${displayName}">`;
      el.addEventListener("dragstart", e => {
        e.dataTransfer.setData("text/plain", JSON.stringify({ name: nameKey, img: char.img, role: char.role, baseName: char.baseName }));
        el.classList.add("dragging");
      });
      el.addEventListener("dragend", () => el.classList.remove("dragging"));
      if (usedNames.has(nameKey)) el.classList.add("used");
      return el;
    }

    function createSlot(type) {
      const slot = document.createElement("div");
      slot.className = "slot";
      slot.dataset.type = type;
      slot.addEventListener("dragover", e => e.preventDefault());
      slot.addEventListener("drop", e => {
        e.preventDefault();
        const data = JSON.parse(e.dataTransfer.getData("text/plain"));
        if (type !== data.role) return;
        const nameKey = data.name;
        const displayName = data.baseName || data.name;

        const row = slot.closest(".team-row");
        const index = Array.from(row.children).indexOf(slot);
        const pairedSlot = row.children[type === "adventurer" ? index + 1 : index - 1];
        const pairedImg = pairedSlot.querySelector("img");
        if (pairedImg && pairedImg.alt.toLowerCase() === displayName.toLowerCase()) {
          alert(`è¯¥å°ç»„ä¸­ä¸èƒ½å‡ºç°é‡å¤è§’è‰²ï¼š${displayName.replace(/_+/g,' ')}`);
          return;
        }

        const targetImg = slot.querySelector("img");
        const sourceSlot = slotMap.get(nameKey);
        if (targetImg) {
          const tgtKey = targetImg.getAttribute("data-name");
          const tgtData = { name: tgtKey, img: targetImg.src, role: type, baseName: targetImg.title };
          if (sourceSlot && sourceSlot !== slot) {
            setSlotImage(sourceSlot, tgtData);
            slotMap.set(tgtKey, sourceSlot);
          }
        } else if (sourceSlot && sourceSlot !== slot) {
          sourceSlot.innerHTML = "";
          slotMap.delete(nameKey);
        }

        // 1. å…ˆä¸´æ—¶æ”¾å…¥ slot
        setSlotImage(slot, data); // <--- è¿™ä¸€æ­¥åªåšä¸´æ—¶ï¼Œä¸è¦å…ˆ saveToLocalï¼

        // 2. æ£€æŸ¥æ‰€æœ‰é˜Ÿä¼æœ‰æ²¡æœ‰åŒç»„åŒå
        if (!checkAllTeamsNoConflict()) {
          // å†²çªï¼šæ’¤å›è¿™æ¬¡æ’å…¥
          slot.innerHTML = "";
          alert("æ‹–æ‹½åä¼šå¯¼è‡´åŒç»„å‡ºç°é‡å¤è§’è‰²ï¼Œæ“ä½œè¢«å–æ¶ˆï¼");
          loadFromLocal();    // â† å½»åº•é‡åˆ·é˜Ÿä¼ï¼ˆä»æœ¬åœ°å­˜å‚¨æ¢å¤ï¼‰
          renderPool(); // åˆ·æ–°å›æ­£å¸¸
          return;
        }

        // 3. æ­£å¸¸æµç¨‹
        slotMap.set(nameKey, slot);

        usedNames.clear();
        slotMap.forEach((v, k) => usedNames.add(k));
        renderPool();
        saveToLocal();
      });
      slot.addEventListener("click", () => {
        const img = slot.querySelector("img");
        if (!img) return;
        const key = img.getAttribute("data-name");
        usedNames.delete(key);
        slotMap.delete(key);
        slot.innerHTML = "";
        renderPool();
        saveToLocal();
      });
      return slot;
    }

    function setSlotImage(slot, char) {
  const nameKey = char.name;
  const displayName = char.baseName || char.name;
  slot.innerHTML = "";
  const img = document.createElement("img");
  img.src = char.img;  // âœ… ç”¨åŸå§‹ç›¸å¯¹è·¯å¾„ï¼Œä¸æ”¹
  img.alt = displayName;
  img.title = displayName;
  img.setAttribute("data-name", nameKey);
  img.setAttribute("data-src", char.img); // âœ… åŠ ä¸ŠçœŸå®è·¯å¾„ï¼ˆç”¨äºå¯¼å‡ºï¼‰
  img.draggable = true;
  img.addEventListener("dragstart", e => {
    e.dataTransfer.setData("text/plain", JSON.stringify(char));
    img.classList.add("dragging");
  });
  img.addEventListener("dragend", () => img.classList.remove("dragging"));
  slot.appendChild(img);
}


    function addTeam() {
      const teamNumber = availableTeamNumbers.length ? availableTeamNumbers.shift() : ++teamCounter;

      const wrapper = document.createElement("div");
      // wrapper.style.display = "flex";
      if (window.innerWidth <= 768) {
        wrapper.style.display = "block";
      } else {
        wrapper.style.display = "flex";
      }
      wrapper.style.alignItems = "stretch";

      const dragHandle = document.createElement("div");
      dragHandle.className = "drag-handle";
      dragHandle.setAttribute("draggable", "true");
      dragHandle.innerHTML = "â‰¡"; // ä½ ä¹Ÿå¯ä»¥ç”¨ iconï¼Œæˆ–è€…ç©ºç™½åŠ æ ·å¼
      wrapper.appendChild(dragHandle);
      // const container = document.createElement("div"); container.className = "team-container";
      const container = document.createElement("div");
      container.className = "team-container";
      container.draggable = true;
      wrapper.appendChild(container);
      addTeamDragEvents(wrapper); // åŠ å…¥æ‹–æ‹½äº‹ä»¶ç»‘å®š
      const header = document.createElement("div"); header.className = "team-header";
      const label = document.createElement("div"); label.className = "team-label";
      label.contentEditable = true; label.spellcheck = false;
      label.textContent = `é˜Ÿä¼ ${teamNumber}`;
      label.dataset.defaultName = label.textContent;
      label.addEventListener("keypress", e => { if(e.key==="Enter"){ e.preventDefault(); label.blur(); }});
      label.addEventListener("blur", () => { if(label.textContent.trim()==="") label.textContent = label.dataset.defaultName; saveToLocal(); });
      const controls = document.createElement("div");
      const clearBtn = document.createElement("button"); clearBtn.textContent="æ¸…ç©º";
      clearBtn.onclick = () => {
        if(!confirm(`ç¡®å®šæ¸…ç©º ${label.textContent}?`)) return;
        row.querySelectorAll(".slot").forEach(s=>{const i=s.querySelector("img"); if(i){usedNames.delete(i.getAttribute("data-name")); slotMap.delete(i.getAttribute("data-name")); s.innerHTML="";}});
        renderPool(); saveToLocal();
      };
      const deleteBtn = document.createElement("button"); deleteBtn.textContent="åˆ é™¤é˜Ÿä¼";
      deleteBtn.onclick = () => {
        if(!confirm(`ç¡®å®šåˆ é™¤ ${label.textContent}?`)) return;
        container.querySelectorAll(".slot img").forEach(i=>{usedNames.delete(i.getAttribute("data-name")); slotMap.delete(i.getAttribute("data-name"));});
        container.remove(); availableTeamNumbers.push(teamNumber); renderPool(); saveToLocal();
      };
      controls.appendChild(clearBtn); controls.appendChild(deleteBtn);
      header.appendChild(label); header.appendChild(controls);
      container.appendChild(header);
      const row = document.createElement("div"); row.className="team-row";
      for(let i=0;i<3;i++){
        row.appendChild(createSlot("adventurer"));
        row.appendChild(createSlot("supporter"));
      }
      container.appendChild(row);
      document.getElementById("teams").appendChild(wrapper);
      saveToLocal();
    }

    function getCurrentData() {
  const teams = [];
  document.querySelectorAll("#teams > div").forEach(wrapper => {
    const container = wrapper.querySelector(".team-container");
    const name = container.querySelector(".team-label").textContent.trim(); // âœ… ç”¨ container æ›¿æ¢ c
    const row = container.querySelector(".team-row");
    const slots = row.querySelectorAll(".slot");
    const team = { name, adventurers: [], supporters: [] };
    slots.forEach(s => {
      const type = s.dataset.type;
      const img = s.querySelector("img");
      team[type + "s"].push(img ? {
        name: img.getAttribute("data-name"),
        img: img.getAttribute("data-src"),
        role: type,
        baseName: img.title
      } : null);
    });
    teams.push(team);
  });
  return teams;
}

    function saveToLocal(){localStorage.setItem("savedTeams", JSON.stringify(getCurrentData()));}
    function loadFromLocal(){ const d=localStorage.getItem("savedTeams"); if(d)renderFromData(JSON.parse(d)); }
    function exportConfig() {
  const data = {
    teams: getCurrentData(),
    eligibleCharacters: Array.from(eligibleCharacters),
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "team_config.json";
  a.click();
}

    function importConfig(e) {
  const f = e.target.files[0];
  if (!f) return;
  const r = new FileReader();
  r.onload = ev => {
    const data = JSON.parse(ev.target.result);
    if (data.teams) renderFromData(data.teams);
    if (Array.isArray(data.eligibleCharacters)) {
      eligibleCharacters = new Set(data.eligibleCharacters);
      localStorage.setItem("eligibleCharacters", JSON.stringify(data.eligibleCharacters));
    }
    saveToLocal();
    renderPool();
  };
  r.readAsText(f);
}

    function renderFromData(data){
  document.getElementById("teams").innerHTML = "";
  usedNames.clear(); slotMap.clear(); availableTeamNumbers.length = 0; teamCounter = 0;

  data.forEach(team => {
    const num = ++teamCounter;

    const wrapper = document.createElement("div");
    // wrapper.style.display = "flex";
    if (window.innerWidth <= 768) {
        wrapper.style.display = "block";
      } else {
        wrapper.style.display = "flex";
      }
    wrapper.style.alignItems = "stretch";

    const dragHandle = document.createElement("div");
    dragHandle.className = "drag-handle";
    dragHandle.setAttribute("draggable", "true");
    dragHandle.innerHTML = "â‰¡";
    wrapper.appendChild(dragHandle);

    const container = document.createElement("div");
    container.className = "team-container";
    wrapper.appendChild(container);

    addTeamDragEvents(wrapper); // âœ… ä¿®æ­£ï¼šç»‘å®š wrapper è€Œä¸æ˜¯ container

    const header = document.createElement("div");
    header.className = "team-header";

    const label = document.createElement("div");
    label.className = "team-label";
    label.contentEditable = true;
    label.spellcheck = false;
    label.textContent = team.name;
    label.dataset.defaultName = team.name;
    label.addEventListener("keypress", e => {
      if (e.key === "Enter") { e.preventDefault(); label.blur(); }
    });
    label.addEventListener("blur", () => {
      if (label.textContent.trim() === "") label.textContent = label.dataset.defaultName;
      saveToLocal();
    });

    const controls = document.createElement("div");

    const clearBtn = document.createElement("button");
    clearBtn.textContent = "æ¸…ç©º";
    clearBtn.onclick = () => {
      if (!confirm(`ç¡®å®šæ¸…ç©º ${label.textContent}?`)) return;
      row.querySelectorAll(".slot").forEach(s => {
        const i = s.querySelector("img");
        if (i) {
          usedNames.delete(i.getAttribute("data-name"));
          slotMap.delete(i.getAttribute("data-name"));
          s.innerHTML = "";
        }
      });
      renderPool(); saveToLocal();
    };

    const deleteBtn = document.createElement("button");
    deleteBtn.textContent = "åˆ é™¤é˜Ÿä¼";
    deleteBtn.onclick = () => {
      if (!confirm(`ç¡®å®šåˆ é™¤ ${label.textContent}?`)) return;
      container.querySelectorAll(".slot img").forEach(i => {
        usedNames.delete(i.getAttribute("data-name"));
        slotMap.delete(i.getAttribute("data-name"));
      });
      wrapper.remove(); // âœ… åˆ é™¤ wrapper è€Œé container
      availableTeamNumbers.push(num);
      renderPool(); saveToLocal();
    };

    controls.appendChild(clearBtn);
    controls.appendChild(deleteBtn);
    header.appendChild(label);
    header.appendChild(controls);
    container.appendChild(header);

    const row = document.createElement("div");
    row.className = "team-row";

    for (let i = 0; i < 3; i++) {
      const advSlot = createSlot("adventurer");
      const advData = team.adventurers[i];
      if (advData) {
        setSlotImage(advSlot, advData);
        slotMap.set(advData.name, advSlot);
        usedNames.add(advData.name);
      }
      row.appendChild(advSlot);

      const supSlot = createSlot("supporter");
      const supData = team.supporters[i];
      if (supData) {
        setSlotImage(supSlot, supData);
        slotMap.set(supData.name, supSlot);
        usedNames.add(supData.name);
      }
      row.appendChild(supSlot);
    }

    container.appendChild(row);
    document.getElementById("teams").appendChild(wrapper);
  });

  renderPool();
}

    let scrollTimer = null;

document.addEventListener("dragover", (e) => {
  const SCROLL_MARGIN = 100;
  const BASE_SPEED = 20;
  const MAX_SPEED = 60;
  const y = e.clientY;
  const windowHeight = window.innerHeight;
  

  let direction = 0;
  let speed = 0;

  if (y < SCROLL_MARGIN) {
    direction = -1;
    speed = Math.min(MAX_SPEED, BASE_SPEED + (SCROLL_MARGIN - y) * 0.5);
  } else if (y > windowHeight - SCROLL_MARGIN) {
    direction = 1;
    speed = Math.min(MAX_SPEED, BASE_SPEED + (y - (windowHeight - SCROLL_MARGIN)) * 0.5);
  }

  if (direction !== 0) {
    if (!scrollTimer) {
      scrollTimer = setInterval(() => {
        window.scrollBy(0, direction * speed);
      }, 16); // æ¯å¸§æ»šåŠ¨
    }
  } else {
    if (scrollTimer) {
      clearInterval(scrollTimer);
      scrollTimer = null;
    }
  }
});

document.addEventListener("drop", () => {
  if (scrollTimer) {
    clearInterval(scrollTimer);
    scrollTimer = null;
  }
});

function checkAllTeamsNoConflict() {
  const teams = document.querySelectorAll("#teams > div");
  for (const wrapper of teams) {
    const row = wrapper.querySelector(".team-row");
    for (let i = 0; i < row.children.length; i += 2) {
      const adv = row.children[i]?.querySelector("img")?.getAttribute("alt")?.toLowerCase();
      const sup = row.children[i+1]?.querySelector("img")?.getAttribute("alt")?.toLowerCase();
      if (adv && sup && adv === sup) {
        return false; // å­˜åœ¨åŒåï¼Œå†²çª
      }
    }
  }
  return true; // æ²¡å†²çª
}


function addTeamDragEvents(wrapper) {
  const dragHandle = wrapper.querySelector(".drag-handle");
  if (!dragHandle) return;

  dragHandle.addEventListener("dragstart", (e) => {
    wrapper.classList.add("dragging");
    e.dataTransfer.effectAllowed = "move";
    window.currentDraggingTeam = wrapper;
  });

  dragHandle.addEventListener("dragend", () => {
    wrapper.classList.remove("dragging");
    window.currentDraggingTeam = null;
  });

  let lastConflict = false;
  let dropTargetIndex = null;

  

  wrapper.addEventListener("dragleave", () => {
    wrapper.style.border = "";
  });
wrapper.addEventListener("dragover", (e) => {
  e.preventDefault();
  const dragging = window.currentDraggingTeam;
  if (!dragging || dragging === wrapper) return;

  const bounding = wrapper.getBoundingClientRect();
  const offset = e.clientY - bounding.top;

  const parent = wrapper.parentNode;
  const refNode = offset > bounding.height / 2 ? wrapper.nextSibling : wrapper;

  // ä¿å­˜å¾…æ’å…¥çš„ç›®æ ‡ä½ç½®ï¼ˆæ‹–åŠ¨æ—¶ä¸ç«‹å³æ’å…¥ï¼‰
  pendingInsert = { parent, dragging, refNode };
});

wrapper.addEventListener("drop", () => {
  wrapper.style.border = "";

  if (!pendingInsert) return;

  const { parent, dragging, refNode } = pendingInsert;

  // æ¨¡æ‹Ÿæ’å…¥åçš„åˆ—è¡¨é¡ºåº
  const tempList = Array.from(parent.children);
  const oldIndex = tempList.indexOf(dragging);
  tempList.splice(oldIndex, 1);
  const newIndex = tempList.indexOf(refNode);
  tempList.splice(newIndex, 0, dragging);

  // æ£€æŸ¥æ’å…¥åçš„æ‰€æœ‰å°ç»„æ˜¯å¦å†²çª
  const conflict = tempList.some(wrap => {
    const row = wrap.querySelector(".team-row");
    for (let i = 0; i < row.children.length; i += 2) {
      const adv = row.children[i]?.querySelector("img")?.getAttribute("alt")?.toLowerCase();
      const sup = row.children[i + 1]?.querySelector("img")?.getAttribute("alt")?.toLowerCase();
      if (adv && sup && adv === sup) {
        return true;
      }
    }
    return false;
  });

  if (conflict) {
    alert("æ‹–æ‹½åä¼šå¯¼è‡´åŒç»„å‡ºç°é‡å¤è§’è‰²ï¼Œæ“ä½œè¢«å–æ¶ˆï¼");
    pendingInsert = null;
    return;
  }

  // âœ… æ— å†²çªæ‰æ‰§è¡Œæ’å…¥
  if (dragging !== refNode) {
    parent.insertBefore(dragging, refNode);
  }

  usedNames.clear();
  slotMap.clear();
  document.querySelectorAll("#teams .slot img").forEach(img => {
    const name = img.getAttribute("data-name");
    const slot = img.closest(".slot");
    if (name && slot) {
      usedNames.add(name);
      slotMap.set(name, slot);
    }
  });

  renderPool();
  saveToLocal();
  pendingInsert = null;
});




}


let eligibleCharacters = new Set(JSON.parse(localStorage.getItem("eligibleCharacters") || "[]"));

    function openEligibleSelector() {
      const container = document.getElementById("eligibleList");
      if (!container) {
        alert("æ‰¾ä¸åˆ° eligibleList å…ƒç´ ï¼Œè¯·æ£€æŸ¥ HTML æ˜¯å¦æ­£ç¡®æ’å…¥ï¼");
        return;
      }
      container.innerHTML = "";
      const allChars = [...(characters?.adventurers || []), ...(characters?.supporters || [])];
      allChars.sort((a, b) => (a.baseName || a.name).localeCompare(b.baseName || b.name, 'zh'));

      allChars.forEach(char => {
        const label = document.createElement("label");
        label.style.display = "flex";
        label.style.alignItems = "center";
        label.style.gap = "6px";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.value = char.name;
        checkbox.checked = eligibleCharacters.has(char.name);

        const img = document.createElement("img");
        img.src = char.img;
        img.alt = char.name;
        img.style.width = "80px";
        img.style.height = "80px";

        label.appendChild(checkbox);
        label.appendChild(img);
        // label.appendChild(document.createTextNode(char.baseName || char.name));
        container.appendChild(label);
      });

      document.getElementById("overlay").style.display = "block";
      document.getElementById("eligibleSelector").style.display = "block";
    }

    function closeEligibleSelector() {
      document.getElementById("overlay").style.display = "none";
      document.getElementById("eligibleSelector").style.display = "none";
    }

    function saveEligible() {
      const selected = Array.from(document.querySelectorAll("#eligibleList input:checked"))
        .map(el => el.value);
      eligibleCharacters = new Set(selected);
      localStorage.setItem("eligibleCharacters", JSON.stringify(selected));
      closeEligibleSelector();
      if (typeof renderPool === 'function') renderPool();
    }
    function toggleFilterPanel() {
  const filters = document.getElementById("filters");
  filters.classList.toggle("show");
  const btn = filters.querySelector(".toggle-filters");
  btn.textContent = filters.classList.contains("show") ? "æ”¶èµ·ç­›é€‰" : "å±•å¼€ç­›é€‰";
}

  </script>
</body>
</html>